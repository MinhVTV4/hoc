<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnPath AI - (v14.3: Sửa lỗi hiển thị Text)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMQNogNJeASiX9UrxmoL2ACafVVfk5TBccNsB6SbAtUWWl0ES" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <!-- New Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            /* Light Theme */
            --bg-primary-light: #f4f5f7;
            --bg-secondary-light: #ffffff;
            --bg-tertiary-light: #f9fafb;
            --text-primary-light: #111827;
            --text-secondary-light: #4b5563;
            --border-light: #e5e7eb;
            --primary-light: #2563eb;
            --primary-hover-light: #1d4ed8;
            --accent-light: #f97316;
            --success-light: #16a34a;
            --shadow-light: rgba(0, 0, 0, 0.06);

            /* Dark Theme */
            --bg-primary-dark: #111827;
            --bg-secondary-dark: #1f2937;
            --bg-tertiary-dark: #374151;
            --text-primary-dark: #f9fafb;
            --text-secondary-dark: #9ca3af;
            --border-dark: #4b5563;
            --primary-dark: #38bdf8;
            --primary-hover-dark: #0ea5e9;
            --accent-dark: #fb923c;
            --success-dark: #4ade80;
            --shadow-dark: rgba(0, 0, 0, 0.2);
        }

        [data-theme="light"] {
            --bg-primary: var(--bg-primary-light);
            --bg-secondary: var(--bg-secondary-light);
            --bg-tertiary: var(--bg-tertiary-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --border: var(--border-light);
            --primary: var(--primary-light);
            --primary-hover: var(--primary-hover-light);
            --accent: var(--accent-light);
            --success: var(--success-light);
            --shadow: var(--shadow-light);
        }

        [data-theme="dark"] {
            --bg-primary: var(--bg-primary-dark);
            --bg-secondary: var(--bg-secondary-dark);
            --bg-tertiary: var(--bg-tertiary-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --border: var(--border-dark);
            --primary: var(--primary-dark);
            --primary-hover: var(--primary-hover-dark);
            --accent: var(--accent-dark);
            --success: var(--success-dark);
            --shadow: var(--shadow-dark);
        }

        html {
            scroll-behavior: smooth;
        }

        body { 
            font-family: var(--font-main); 
            margin: 0; 
            padding: 20px; 
            background-color: var(--bg-primary); 
            color: var(--text-primary); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            transition: background-color 0.3s, color 0.3s;
        }
        .container { width: 100%; max-width: 850px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .header-title { display: flex; align-items: center; gap: 12px; }
        .header-title span { font-size: 2.2rem; }
        .header-actions { display: flex; align-items: center; }
        #theme-toggle-btn {
            background: none; border: 1px solid var(--border); color: var(--text-secondary);
            width: 44px; height: 44px; padding: 0; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        #theme-toggle-btn:hover { background-color: var(--bg-tertiary); }
        h1, h2 { text-align: center; margin-bottom: 5px; }
        h1 { font-size: 2.2rem; color: var(--text-primary); }
        h2 { font-size: 1.2rem; font-weight: 400; margin-bottom: 30px; color: var(--text-secondary); }
        #controls { margin-bottom: 30px; background-color: var(--bg-secondary); padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--border); transition: background-color 0.3s, border-color 0.3s; }
        input[type="text"], select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 16px; background-color: var(--bg-secondary); color: var(--text-primary); }
        input[type="text"]:focus, select:focus { border-color: var(--primary); outline: 0; box-shadow: 0 0 0 0.2rem color-mix(in srgb, var(--primary) 25%, transparent); }
        button { width: 100%; padding: 14px 25px; background-color: var(--primary); color: var(--bg-secondary); border: none; border-radius: 8px; cursor: pointer; font-size: 17px; transition: background-color 0.3s ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; }
        button:hover { background-color: var(--primary-hover); }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.6; }
        #clearProgressButton { background-color: var(--text-secondary); margin-top: 10px; color: var(--bg-secondary); }
        #clearProgressButton:hover { opacity: 0.8; }
        #responseContainer { background-color: var(--bg-secondary); border-radius: 16px; min-height: 100px; width: 100%; padding: 15px; box-sizing: border-box; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--border); }
        .learning-path ol { list-style-type: none; padding-left: 0; margin: 0; counter-reset: lesson-counter; }
        .learning-path li { background-color: var(--bg-tertiary); margin-bottom: 10px; padding: 15px 20px 15px 55px; border-radius: 12px; border-left: 5px solid var(--text-secondary); counter-increment: lesson-counter; position: relative; transition: all 0.3s ease; }
        .learning-path li[data-state="locked"] { background-color: color-mix(in srgb, var(--bg-tertiary) 50%, transparent); border-left-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }
        .learning-path li[data-state="unlocked"] { border-left-color: var(--primary); cursor: pointer; }
        .learning-path li[data-state="unlocked"]:hover { background-color: color-mix(in srgb, var(--bg-primary) 50%, var(--bg-secondary) 50%); box-shadow: 0 2px 5px var(--shadow); }
        .learning-path li[data-state="completed"] { border-left-color: var(--success); background-color: color-mix(in srgb, var(--success) 8%, var(--bg-secondary)); cursor: pointer; }
        .learning-path li::before { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); background-color: var(--text-secondary); color: var(--bg-secondary); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: monospace; font-size: 1.2rem; content: "🔒"; }
        .learning-path li[data-state="unlocked"]::before { background-color: var(--primary); content: counter(lesson-counter); }
        .learning-path li[data-state="completed"]::before { background-color: var(--success); content: "✓"; }
        .lesson-title { font-weight: 500; font-size: 1.05rem; color: var(--text-primary); }
        .learning-path li.active { border-left-color: var(--accent); }
        .learning-path li.active::before { background-color: var(--accent); }
        .learning-path li[data-state="completed"].active { border-left-color: color-mix(in srgb, var(--success) 80%, black); }
        .learning-path li[data-state="completed"].active::before { background-color: color-mix(in srgb, var(--success) 80%, black); }
        .lesson-detail { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .learning-path li.active .lesson-detail { display: block; }
        .lesson-block { background-color: var(--bg-secondary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .lesson-block-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .lesson-block.explanation { border-left: 4px solid #17a2b8; }
        .lesson-block.explanation .lesson-block-title { color: #17a2b8; }
        .lesson-block.example { border-left: 4px solid #ffc107; background-color: color-mix(in srgb, #ffc107 10%, var(--bg-secondary));}
        .lesson-block.example .lesson-block-title { color: #d39e00; }
        .lesson-block.note { border-left: 4px solid #6f42c1; background-color: color-mix(in srgb, #6f42c1 10%, var(--bg-secondary)); }
        .lesson-block.note .lesson-block-title { color: #6f42c1; }
        .summary-quiz-title { font-size: 1.3rem; font-weight: 600; color: #d63384; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .practice-set .quiz-container { margin-bottom: 15px; }
        .practice-set .quiz-container:last-child { margin-bottom: 0; }
        .lesson-content { white-space: normal; word-wrap: break-word; line-height: 1.7; color: var(--text-secondary); }
        .lesson-content p { margin-top: 0; margin-bottom: 1rem; }
        .lesson-content ul, .lesson-content ol { padding-left: 20px; }
        .lesson-content li { margin-bottom: 0.5rem; }
        .lesson-content strong { color: var(--text-primary); }
        .lesson-content code { background-color: var(--bg-tertiary); padding: 2px 6px; border-radius: 6px; font-family: monospace; border: 1px solid var(--border); }
        .status-message { margin-top: 15px; font-weight: bold; font-size: 0.95rem; text-align: center; width: 100%; }
        .status-message.error-text { color: #dc3545; }
        .status-message.success-text { color: #28a745; }
        .status-message.info-text { color: #17a2b8; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        button.loading .spinner { display: block; }
        .large-spinner, .small-spinner { border-radius: 50%; animation: spin 1.2s linear infinite; margin: auto; }
        .large-spinner { width: 50px; height: 50px; border: 5px solid var(--bg-tertiary); border-top: 5px solid var(--primary);}
        .small-spinner { width: 30px; height: 30px; border: 3px solid var(--bg-tertiary); border-top: 3px solid var(--primary);}
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .quiz-container { background-color: color-mix(in srgb, var(--primary) 8%, var(--bg-secondary)); border: 1px solid color-mix(in srgb, var(--primary) 20%, transparent); border-radius: 8px; padding: 20px; }
        .quiz-container p { margin-top: 0; font-weight: bold; }
        .quiz-options button { display: block; width: 100%; text-align: left; margin-bottom: 10px; background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
        .quiz-options button:hover:not(:disabled) { background-color: var(--bg-tertiary); }
        .quiz-tf-options { display: flex; gap: 10px; }
        .quiz-tf-options button { flex: 1; text-align: center; }
        .quiz-container button.correct { background-color: #d4edda; border-color: #c3e6cb; color: #155724; font-weight: bold; }
        .quiz-container button.incorrect { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        [data-theme="dark"] .quiz-container button.correct { background-color: #1a3c2a; border-color: #2a6a4a; color: #8ce99a; }
        [data-theme="dark"] .quiz-container button.incorrect { background-color: #4d1a21; border-color: #8b2a3a; color: #ffa8a8; }
        .quiz-feedback { margin-top: 15px; padding: 10px; border-radius: 6px; display: none; }
        .quiz-feedback.visible { display: block; }
        .quiz-feedback.correct { background-color: #d4edda; color: #155724; }
        .quiz-feedback.incorrect { background-color: #f8d7da; color: #721c24; }
        [data-theme="dark"] .quiz-feedback.correct { background-color: #1a3c2a; color: #8ce99a; }
        [data-theme="dark"] .quiz-feedback.incorrect { background-color: #4d1a21; color: #ffa8a8; }
        .quiz-fib-input { padding: 8px; border: 1px solid var(--border); border-radius: 4px; margin: 0 5px; background-color: var(--bg-secondary); color: var(--text-primary);}
        .check-fib-btn { width: auto; font-size: 15px; padding: 8px 16px; margin-left: 10px; }
        .retry-button { background-color: var(--text-secondary); font-size: 14px; padding: 10px 20px; margin-top: 10px; width: auto; color: var(--bg-secondary); }
        .retry-button:hover { opacity: 0.8; }
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5em 0; }
        .feedback-actions { margin-top: 12px; display: flex; gap: 10px; }
        .feedback-actions button { font-size: 14px; padding: 8px 12px; width: auto; }
        .reinforce-btn { background-color: #6f42c1; } .reinforce-btn:hover { background-color: #59369a; }
        .expand-btn { background-color: #17a2b8; } .expand-btn:hover { background-color: #138496; }
        #welcomeMessage { display: none; background-color: color-mix(in srgb, var(--primary) 15%, var(--bg-secondary)); border-left: 5px solid var(--primary); border-radius: 8px; padding: 20px; margin-bottom: 25px; line-height: 1.6; }
        #welcomeMessage p { margin: 0; }
        #welcomeMessage .small-spinner { margin: 0; display: inline-block; vertical-align: middle; margin-right: 10px;}
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--bg-secondary); margin: 10% auto; padding: 25px; border: 1px solid var(--border); width: 90%; max-width: 700px; border-radius: 12px; position: relative; box-shadow: 0 5px 15px var(--shadow); }
        .modal-close { color: var(--text-secondary); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: var(--text-primary); }
        .modal-header { padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: var(--primary); }
        .modal-body { line-height: 1.7; color: var(--text-secondary); }
        .modal-body .prose { max-width: none; }
        
        #scrollToTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--primary);
            color: white;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            visibility: hidden;
        }
        #scrollToTopBtn.visible {
            display: flex;
            align-items: center;
            justify-content: center;
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.1rem; margin-bottom: 20px; }
            #controls, #responseContainer { padding: 15px; }
            .learning-path li { padding: 12px 15px 12px 45px; }
            .learning-path li::before { width: 26px; height: 26px; left: 8px; }
            .lesson-block, .quiz-container { padding: 15px; }
            .modal-content { width: 95%; margin: 5% auto; }
            #scrollToTopBtn { bottom: 15px; right: 15px; width: 45px; height: 45px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <span style="font-size: 2.2rem; color: var(--primary);">🎓</span>
                <h1>LearnPath AI</h1>
            </div>
            <div class="header-actions">
                <button id="theme-toggle-btn" aria-label="Toggle dark mode">
                    <span class="sun-icon">☀️</span>
                    <span class="moon-icon" style="display: none;">🌙</span>
                </button>
            </div>
        </div>
        <h2>(v14.3: Sửa lỗi hiển thị Text)</h2>

        <div id="controls">
            <input type="text" id="topicInput" placeholder="Ví dụ: Định lý Pythagoras">
            
            <label for="pathLengthSelect" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 15px;">Độ chi tiết của lộ trình:</label>
            <select id="pathLengthSelect">
                <option value="3 đến 4 bước">Tóm tắt (3-4 bước)</option>
                <option value="5 đến 6 bước" selected>Tiêu chuẩn (5-6 bước)</option>
                <option value="7 đến 9 bước">Chi tiết (7-9 bước)</option>
            </select>
            
            <label for="learnerLevelSelect" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 15px;">Trình độ người học:</label>
            <select id="learnerLevelSelect">
                <option value="người mới bắt đầu">Người mới bắt đầu</option>
                <option value="người có kiến thức cơ bản" selected>Người có cơ bản</option>
                <option value="người muốn tìm hiểu nâng cao">Nâng cao</option>
            </select>

            <button id="generatePathButton">
                <span class="button-text">Tạo Lộ trình</span>
                <div class="spinner"></div>
            </button>
            <button id="clearProgressButton">Xóa tiến trình</button>
            <p id="statusMessage" class="status-message"></p>
        </div>
        
        <div id="welcomeMessage"></div>

        <h2>Lộ trình học đề xuất:</h2>
        <div id="responseContainer">Chưa có lộ trình nào được tạo...</div>
    </div>
    
    <div id="aiTutorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close">&times;</span>
                <h3 id="aiTutorModalTitle">Trợ lý AI</h3>
            </div>
            <div id="aiTutorModalBody" class="modal-body">
                <p>Nội dung sẽ được tải ở đây...</p>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        
        const LS_KEY = 'learningPathState';
        const THEME_KEY = 'themePreference';

        // --- Theme Management ---
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const sunIcon = themeToggleBtn.querySelector('.sun-icon');
        const moonIcon = themeToggleBtn.querySelector('.moon-icon');
        
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            if (theme === 'dark') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'inline-block';
            } else {
                sunIcon.style.display = 'inline-block';
                moonIcon.style.display = 'none';
            }
        }
        
        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, newTheme);
            applyTheme(newTheme);
        });

        // --- Main App Logic ---

        function saveState() {
            const topic = topicInput.value.trim();
            const pathHTML = responseContainer.innerHTML;
            if (topic && pathHTML && pathHTML !== 'Chưa có lộ trình nào được tạo...') {
                const state = { topic, pathHTML };
                localStorage.setItem(LS_KEY, JSON.stringify(state));
                console.log("Tiến trình đã được lưu!");
            }
        }

        function markStepAsCompleted(quizElement) {
            const currentLi = quizElement.closest('li');
            if (!currentLi || currentLi.dataset.state === 'completed') return;
            currentLi.dataset.state = 'completed';
            const nextLi = currentLi.nextElementSibling;
            if (nextLi && nextLi.dataset.state === 'locked') {
                nextLi.dataset.state = 'unlocked';
            }
            saveState(); 
        }
        
        function renderKatexInElement(element) {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true} ],
                    throwOnError: false
                });
            }
        }
        
        const aiTutorModal = document.getElementById('aiTutorModal');
        const aiTutorModalTitle = document.getElementById('aiTutorModalTitle');
        const aiTutorModalBody = document.getElementById('aiTutorModalBody');
        const modalCloseBtn = aiTutorModal.querySelector('.modal-close');

        function showTutorModal(title, content) {
            aiTutorModalTitle.textContent = title;
            aiTutorModalBody.innerHTML = content;
            aiTutorModal.style.display = 'block';
            renderKatexInElement(aiTutorModalBody);
        }
        
        function hideTutorModal() {
            aiTutorModal.style.display = 'none';
        }
        modalCloseBtn.onclick = hideTutorModal;
        window.onclick = (event) => {
            if (event.target == aiTutorModal) {
                hideTutorModal();
            }
        }

        const toolImplementations = {
            createMultipleChoiceQuiz(args, container) {
                const { question, options, correctAnswerIndex, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createMultipleChoiceQuiz';
                container.dataset.quizArgs = JSON.stringify(args);
                
                container.innerHTML = `<p>${question}</p><div class="quiz-options">${options.map((o, i) => `<button data-index="${i}">${o}</button>`).join('')}</div><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.quiz-options').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn || btn.parentElement.querySelector(':disabled')) return;
                    
                    const selected = parseInt(btn.dataset.index);
                    const isCorrect = selected === correctAnswerIndex;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    
                    let feedbackHTML = `<p>${explanation}</p><div class="feedback-actions"></div>`;
                    feedbackEl.innerHTML = feedbackHTML;

                    const actionsContainer = feedbackEl.querySelector('.feedback-actions');
                    if (isCorrect) {
                        actionsContainer.innerHTML = `<button class="expand-btn">Mở rộng kiến thức ✨</button>`;
                        actionsContainer.querySelector('.expand-btn').onclick = () => requestExpansion(args);
                    } else {
                        actionsContainer.innerHTML = `<button class="reinforce-btn">Củng cố kiến thức 🤔</button>`;
                        actionsContainer.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, options[selected]);
                    }
                    
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    renderKatexInElement(feedbackEl);
                    container.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        if (parseInt(b.dataset.index) === correctAnswerIndex) b.classList.add('correct');
                        else if (parseInt(b.dataset.index) === selected) b.classList.add('incorrect');
                    });
                    markStepAsCompleted(container);
                });
            },
            createFillInTheBlankQuiz(args, container) {
                const { sentence, correctAnswer, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createFillInTheBlankQuiz';
                container.dataset.quizArgs = JSON.stringify(args);

                container.innerHTML = `<p>${sentence.replace("___", `<input type="text" class="quiz-fib-input" placeholder="...">`)}</p><button class="check-fib-btn">Kiểm tra</button><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.check-fib-btn').addEventListener('click', () => {
                    const input = container.querySelector('input');
                    const userAnswer = input.value.trim();
                    const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    
                    input.disabled = true;
                    container.querySelector('.check-fib-btn').disabled = true;
                    
                    let feedbackHTML = `<p><strong>Giải thích:</strong> ${explanation}</p><div class="feedback-actions"></div>`;
                    feedbackEl.innerHTML = feedbackHTML;
                    const actionsContainer = feedbackEl.querySelector('.feedback-actions');
                    if(isCorrect) {
                         actionsContainer.innerHTML = `<button class="expand-btn">Mở rộng kiến thức ✨</button>`;
                         actionsContainer.querySelector('.expand-btn').onclick = () => requestExpansion(args);
                    } else {
                        actionsContainer.innerHTML = `<button class="reinforce-btn">Củng cố kiến thức 🤔</button>`;
                        actionsContainer.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, userAnswer);
                    }
                    
                    renderKatexInElement(feedbackEl);
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    input.classList.add(isCorrect ? 'correct' : 'incorrect');
                    if (!isCorrect) input.value += ` (Đúng: ${correctAnswer})`;
                    markStepAsCompleted(container);
                });
            },
            createTrueFalseQuiz(args, container) {
                const { statement, isCorrect, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createTrueFalseQuiz';
                container.dataset.quizArgs = JSON.stringify(args);

                container.innerHTML = `<p>${statement}</p><div class="quiz-tf-options"><button data-answer="true">Đúng</button><button data-answer="false">Sai</button></div><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.quiz-tf-options').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn || btn.parentElement.querySelector(':disabled')) return;
                    
                    const answer = btn.dataset.answer === 'true';
                    const isCorrectAnswer = answer === isCorrect;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    
                    let feedbackHTML = `<p>${explanation}</p><div class="feedback-actions"></div>`;
                    feedbackEl.innerHTML = feedbackHTML;
                    const actionsContainer = feedbackEl.querySelector('.feedback-actions');
                     if(isCorrectAnswer) {
                         actionsContainer.innerHTML = `<button class="expand-btn">Mở rộng kiến thức ✨</button>`;
                         actionsContainer.querySelector('.expand-btn').onclick = () => requestExpansion(args);
                    } else {
                        actionsContainer.innerHTML = `<button class="reinforce-btn">Củng cố kiến thức 🤔</button>`;
                        actionsContainer.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, answer ? 'Đúng' : 'Sai');
                    }
                    
                    renderKatexInElement(feedbackEl);
                    feedbackEl.className = `quiz-feedback visible ${isCorrectAnswer ? 'correct' : 'incorrect'}`;
                    container.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        if ((b.dataset.answer === 'true') === isCorrect) b.classList.add('correct');
                    });
                    if (!isCorrectAnswer) btn.classList.add('incorrect');
                    markStepAsCompleted(container);
                });
            }
        };

        const firebaseConfig = {
            apiKey: "AIzaSyC3fY7kRz2P9BBIBd_jr7b3z5ZUpG5JH8g",
            authDomain: "cboxauto-minh.firebaseapp.com",
            projectId: "cboxauto-minh",
            storageBucket: "cboxauto-minh.appspot.com",
            messagingSenderId: "476350924183",
            appId: "1:476350924183:web:d40a9da3c8902e1d7230d2"
        };
        const app = initializeApp(firebaseConfig);
        const topicInput = document.getElementById('topicInput');
        const generatePathButton = document.getElementById('generatePathButton');
        const clearProgressButton = document.getElementById('clearProgressButton');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');

        function updateStatus(type, message) { statusMessage.className = `status-message ${type}`; statusMessage.innerHTML = message; }
        function toggleButtonLoading(isLoading) { const btnTxt = generatePathButton.querySelector('.button-text'); generatePathButton.disabled = isLoading; generatePathButton.classList.toggle('loading', isLoading); btnTxt.textContent = isLoading ? 'Đang tạo...' : 'Tạo Lộ trình'; }
        
        function parseAiJson(text) {
            const match = text.match(/```(json)?\s*([\s\S]*?)\s*```/); 
            let jsonString = text;
            if (match && match[2]) {
                jsonString = match[2].trim();
            } else {
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace > firstBrace) {
                    jsonString = text.substring(firstBrace, lastBrace + 1);
                }
            }
            try { return JSON.parse(jsonString); } catch (e) {
                console.warn("Lỗi JSON parse lần 1, thử sửa lỗi...", e);
                const repairedString = jsonString.replace(/,\s*([}\]])/g, '$1');
                try { return JSON.parse(repairedString); } catch (finalError) {
                     console.error("Không thể sửa và parse JSON:", finalError);
                     throw new Error("Dữ liệu JSON từ AI không hợp lệ.");
                }
            }
        }
        
        const quizTools = [{ 
            functionDeclarations: [
                { name: 'createMultipleChoiceQuiz', description: 'Tạo một câu hỏi trắc nghiệm.', parameters: { type: 'OBJECT', properties: { question: { type: 'STRING' }, options: { type: 'ARRAY', items: { type: 'STRING' } }, correctAnswerIndex: { type: 'NUMBER' }, explanation: { type: 'STRING', description: 'Giải thích ngắn gọn tại sao đáp án lại đúng.' } }, required: ['question', 'options', 'correctAnswerIndex', 'explanation'] } },
                { name: 'createFillInTheBlankQuiz', description: 'Tạo một câu hỏi điền vào chỗ trống.', parameters: { type: 'OBJECT', properties: { sentence: { type: 'STRING', description: 'Câu chứa ký hiệu ___ cho chỗ trống.' }, correctAnswer: { type: 'STRING' }, explanation: { type: 'STRING', description: 'Giải thích ngắn gọn tại sao đáp án lại đúng.' } }, required: ['sentence', 'correctAnswer', 'explanation'] } },
                { name: 'createTrueFalseQuiz', description: 'Tạo một câu hỏi dạng Đúng hoặc Sai.', parameters: { type: 'OBJECT', properties: { statement: { type: 'STRING' }, isCorrect: { type: 'BOOLEAN' }, explanation: { type: 'STRING', description: 'Giải thích ngắn gọn tại sao đáp án lại đúng.' } }, required: ['statement', 'isCorrect', 'explanation'] } }
            ]
        }];

        let model;
        try {
            model = getGenerativeModel(getAI(app), { model: "gemini-2.5-flash" }); 
            updateStatus('success-text', "Mô hình AI đã sẵn sàng!");
        } catch (e) {
            console.error("Lỗi khởi tạo AI Model:", e);
            updateStatus('error-text', `Lỗi khởi tạo AI Model: ${e.message}.`);
        }
        
        async function getLessonDetail(topic, detailElement) {
            if (!model) { detailElement.innerHTML = `<p class="error">Mô hình AI chưa sẵn sàng.</p>`; return; }
            detailElement.innerHTML = '<div class="small-spinner"></div>';
            
            try {
                // Call 1: Get lesson content as JSON
                const lessonPrompt = `Bạn là một gia sư AI chuyên nghiệp. Hãy tạo nội dung bài học về chủ đề: "${topic}".
                **QUY TẮC BẮT BUỘC:**
                1. Mọi công thức toán học hoặc ký hiệu logic (ví dụ \\land, \\implies) PHẢI dùng cú pháp KaTeX và được bao bọc trong dấu đô la (ví dụ: $\\land$).
                2. Escape dấu '\\' thành '\\\\'. Ví dụ: $\\pi$ phải được viết là "$\\\\pi$".
                3. Chỉ trả lời bằng một khối mã JSON hợp lệ duy nhất.
                \`\`\`json
                {
                  "lessonTitle": "...",
                  "introduction": "...",
                  "contentBlocks": [
                    { "type": "explanation", "title": "...", "content": "..." },
                    { "type": "example", "title": "...", "content": "..." }
                  ]
                }
                \`\`\``;

                const lessonResult = await model.generateContent(lessonPrompt);
                const lessonData = parseAiJson(lessonResult.response.text());
                if (!lessonData) throw new Error("Dữ liệu bài học từ AI không hợp lệ.");
                
                renderStructuredLesson(lessonData, detailElement);

                // Call 2: Get quizzes using Function Calling
                const quizPrompt = `Dựa vào chủ đề bài học "${topic}", hãy tạo 2-3 câu hỏi ôn tập bằng các công cụ được cung cấp. Đảm bảo mọi công thức hoặc ký hiệu toán học trong các tham số của công cụ (như question, explanation) đều tuân thủ quy tắc KaTeX.`;
                const quizResult = await model.generateContent({
                    contents: [{ role: 'user', parts: [{ text: quizPrompt }] }],
                    tools: quizTools
                });
                
                const functionCalls = quizResult.response.functionCalls();
                if (functionCalls && functionCalls.length > 0) {
                    renderSummaryQuiz(functionCalls, detailElement);
                }
                
                saveState();
            } catch (error) {
                console.error("Lỗi khi lấy chi tiết bài học:", error);
                detailElement.innerHTML = `<p class="status-message error-text">Không thể tải nội dung. Vấn đề có thể do dữ liệu từ AI không hợp lệ. Vui lòng thử lại.</p><button class="retry-button">Thử lại</button>`;
                detailElement.querySelector('.retry-button').addEventListener('click', () => getLessonDetail(topic, detailElement));
            }
        }

        function renderStructuredLesson(data, parentElement) {
            parentElement.innerHTML = ''; 
            if (data.introduction) {
                const introBlock = document.createElement('div');
                introBlock.className = 'lesson-block explanation';
                introBlock.innerHTML = `<div class="lesson-block-title">${getIconForBlockType('explanation')} <span>${data.lessonTitle || 'Giới thiệu'}</span></div><div class="lesson-content">${marked.parse(data.introduction)}</div>`;
                parentElement.appendChild(introBlock);
            }
            if (data.contentBlocks && Array.isArray(data.contentBlocks)) {
                data.contentBlocks.forEach(block => {
                    const blockEl = document.createElement('div');
                    blockEl.className = `lesson-block ${block.type || 'explanation'}`;
                    blockEl.innerHTML = `<div class="lesson-block-title">${getIconForBlockType(block.type)}<span>${block.title}</span></div><div class="lesson-content">${marked.parse(block.content)}</div>`;
                    parentElement.appendChild(blockEl);
                });
            }
            renderKatexInElement(parentElement);
        }
        
        function getIconForBlockType(type) {
            const icons = {
                example: '💡',
                note: '📌',
                explanation: '🧠'
            };
            return icons[type] || icons['explanation'];
        }

        function renderSummaryQuiz(functionCalls, parentElement) {
            const block = document.createElement('div');
            block.className = 'practice-set';
            block.innerHTML = `<div class="summary-quiz-title">📝 <span>Bài tập tổng kết</span></div>`;
            parentElement.appendChild(block);

            functionCalls.forEach(call => {
                const exerciseContainer = document.createElement('div');
                exerciseContainer.className = 'quiz-container';
                block.appendChild(exerciseContainer);
                
                const implementation = toolImplementations[call.name];
                if (implementation) {
                    implementation(call.args, exerciseContainer);
                } else {
                    console.warn(`Không tìm thấy hàm triển khai cho công cụ: ${call.name}`);
                    exerciseContainer.textContent = `Lỗi: Không thể hiển thị bài tập loại "${call.name}".`;
                }
            });
        }

        async function generateLearningPath() {
             if (!model) { updateStatus('error-text', "Mô hình AI chưa được khởi tạo."); return; }
             const topic = topicInput.value.trim();
             if (!topic) { updateStatus('error-text', "Vui lòng nhập một chủ đề!"); return; }

             const pathLengthSelect = document.getElementById('pathLengthSelect');
             const pathLength = pathLengthSelect.value;
             
             const learnerLevelSelect = document.getElementById('learnerLevelSelect');
             const learnerLevel = learnerLevelSelect.value;

             updateStatus('info-text', `Đang tạo lộ trình...`);
             responseContainer.innerHTML = '<div class="large-spinner"></div>';
             toggleButtonLoading(true);

             const prompt = `Tạo một lộ trình học gồm ${pathLength} rõ ràng và tuần tự cho chủ đề: "${topic}", phù hợp với trình độ của một "${learnerLevel}". Chỉ trả lời bằng một đối tượng JSON hợp lệ duy nhất, không có văn bản nào khác. Cấu trúc: {"learningPath": ["Bước 1: Giới thiệu...", "Bước 2: Tìm hiểu sâu...", ...]}`;
             
             try {
                const result = await model.generateContent(prompt);
                const pathData = parseAiJson(result.response.text());
                const pathItems = pathData.learningPath;
                if (!Array.isArray(pathItems) || pathItems.length === 0) throw new Error("Invalid path data");
                responseContainer.innerHTML = `<div class="learning-path"><ol>${pathItems.map((item, index) => `<li data-topic="${item.replace(/"/g, '&quot;')}" data-state="${index === 0 ? 'unlocked' : 'locked'}"><span class="lesson-title">${item}</span><div class="lesson-detail"></div></li>`).join('')}</ol></div>`;
                updateStatus('success-text', "Đã tạo lộ trình! Nhấp vào mục đầu tiên để bắt đầu.");
                saveState();
             } catch (error) {
                console.error("Lỗi khi tạo lộ trình:", error);
                responseContainer.innerHTML = `<p class="status-message error-text">Không thể tạo lộ trình. Vui lòng thử lại.</p>`;
                updateStatus('error-text', `Lỗi: ${error.message}`);
             } finally {
                toggleButtonLoading(false);
             }
        }
        
        async function requestReinforcement(questionArgs, userAnswer) {
            showTutorModal("Củng cố kiến thức", '<div class="small-spinner"></div>');
            const questionText = questionArgs.question || questionArgs.statement;
            const correctAnswer = questionArgs.correctAnswer || (questionArgs.options ? questionArgs.options[questionArgs.correctAnswerIndex] : 'N/A');
            const prompt = `Bạn là một gia sư AI tận tình. Một học sinh vừa trả lời SAI một câu hỏi. Hãy cung cấp một bài học ngắn gọn (bằng tiếng Việt, dùng Markdown) để giúp họ hiểu rõ lỗi sai và củng cố kiến thức. Đảm bảo mọi công thức/ký hiệu toán học đều dùng KaTeX và được bao bọc trong dấu đô la.
            - **Câu hỏi:** "${questionText}"
            - **Câu trả lời sai của học sinh:** "${userAnswer}"
            - **Đáp án đúng:** "${correctAnswer}"
            
            Bài học của bạn nên có:
            1.  **Phân tích lỗi sai:** Giải thích tại sao câu trả lời của họ chưa đúng.
            2.  **Giải thích khái niệm:** Giảng lại ngắn gọn về kiến thức cốt lõi.
            3.  **Ví dụ minh họa:** Cung cấp 1-2 ví dụ khác để làm rõ.`;
            try {
                const result = await model.generateContent(prompt);
                showTutorModal("Củng cố kiến thức", marked.parse(result.response.text()));
            } catch(e) { showTutorModal("Lỗi", "Không thể kết nối với AI để tạo bài học."); }
        }

        async function requestExpansion(questionArgs) {
            showTutorModal("Mở rộng kiến thức", '<div class="small-spinner"></div>');
            const questionText = questionArgs.question || questionArgs.statement;
            const prompt = `Bạn là một gia sư AI thân thiện. Một học sinh vừa trả lời ĐÚNG câu hỏi sau: "${questionText}". 
            Hãy khen ngợi họ và cung cấp một mẩu kiến thức mở rộng ngắn gọn (bằng tiếng Việt, dùng Markdown) để giúp họ hiểu sâu hơn về chủ đề liên quan hoặc một ứng dụng thú vị của kiến thức đó. Đảm bảo mọi công thức/ký hiệu toán học đều dùng KaTeX và được bao bọc trong dấu đô la.`;
            try {
                const result = await model.generateContent(prompt);
                showTutorModal("Mở rộng kiến thức", marked.parse(result.response.text()));
            } catch(e) { showTutorModal("Lỗi", "Không thể kết nối với AI để tạo bài học."); }
        }

        responseContainer.addEventListener('click', async (event) => {
            const li = event.target.closest('li');
            if (!li) return;
            if (li.dataset.state === 'locked') { li.style.animation = 'shake 0.5s'; setTimeout(() => li.style.animation = '', 500); return; }
            if (event.target.closest('.quiz-container') || event.target.closest('.feedback-actions') || event.target.classList.contains('retry-button')) return;
            
            const wasActive = li.classList.contains('active');
            responseContainer.querySelectorAll('li').forEach(item => item.classList.remove('active'));
            if (!wasActive) {
                li.classList.add('active');
                li.scrollIntoView({ behavior: 'smooth', block: 'start' });

                const detailEl = li.querySelector('.lesson-detail');
                if (detailEl && detailEl.innerHTML === '') {
                    await getLessonDetail(li.dataset.topic, detailEl);
                }
            }
            saveState();
        });

        generatePathButton.addEventListener("click", generateLearningPath);

        async function generateWelcomeBackMessage(mainTopic, lastLessonTopic) {
            if (!model || !lastLessonTopic) return;
            const welcomeContainer = document.getElementById('welcomeMessage');
            welcomeContainer.style.display = 'block';
            welcomeContainer.innerHTML = `<div class="small-spinner"></div> <p>AI đang viết lời chào mừng...</p>`;

            const prompt = `Bạn là một trợ lý học tập AI thân thiện. Người dùng vừa quay lại ứng dụng học tập. Hãy tạo một lời chào mừng ngắn gọn (2-3 câu), thân thiện và khích lệ để chào họ quay trở lại. - Chủ đề chính họ đang học là: "${mainTopic}" - Bài học gần nhất họ xem là: "${lastLessonTopic}". Gợi ý cho họ tiếp tục học từ bài đó. Trả lời bằng văn bản thuần túy, không dùng Markdown hay JSON.`;

            try {
                const result = await model.generateContent(prompt);
                const message = result.response.text().replace(/\n/g, '<br>');
                welcomeContainer.innerHTML = `<p><strong>Trợ lý AI:</strong> ${message}</p>`;
            } catch (error) {
                console.error("Lỗi tạo lời chào:", error);
                welcomeContainer.innerHTML = `<p>Chào mừng bạn đã quay trở lại! Hãy cùng tiếp tục học về <strong>${mainTopic}</strong> nhé.</p>`;
            }
        }
        
        function rehydrateQuizzes() {
            responseContainer.querySelectorAll('.quiz-container').forEach(container => {
                const type = container.dataset.quizType;
                const argsJSON = container.dataset.quizArgs;
                
                const isAnswered = container.querySelector('button:disabled');

                if (type && argsJSON && toolImplementations[type] && !isAnswered) {
                    try {
                        const args = JSON.parse(argsJSON);
                        toolImplementations[type](args, container);
                    } catch (e) {
                        console.error("Lỗi khi rehydrate quiz:", e, container);
                    }
                }
            });
        }

        function loadState() {
            const savedStateJSON = localStorage.getItem(LS_KEY);
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    topicInput.value = savedState.topic;
                    responseContainer.innerHTML = savedState.pathHTML;
                    
                    responseContainer.querySelectorAll('.lesson-content, .quiz-container, .quiz-feedback').forEach(el => {
                        renderKatexInElement(el);
                    });
                    
                    rehydrateQuizzes();
                    
                    const lastActiveLI = responseContainer.querySelector('li.active');
                    generateWelcomeBackMessage(savedState.topic, lastActiveLI?.dataset.topic);
                    updateStatus('success-text', 'Đã tải lại lộ trình học của bạn!');
                } catch(e) {
                    console.error("Lỗi khi tải tiến trình:", e);
                    localStorage.removeItem(LS_KEY); 
                }
            }
        }
        
        clearProgressButton.addEventListener('click', () => {
             const userConfirmed = window.confirm('Bạn có chắc muốn xóa tất cả tiến trình đã lưu?');
            if (userConfirmed) {
                localStorage.removeItem(LS_KEY);
                topicInput.value = '';
                responseContainer.innerHTML = 'Chưa có lộ trình nào được tạo...';
                document.getElementById('welcomeMessage').style.display = 'none';
                updateStatus('info-text', 'Đã xóa tiến trình. Bạn có thể bắt đầu lại.');
            }
        });

        const scrollToTopBtn = document.createElement('button');
        scrollToTopBtn.id = 'scrollToTopBtn';
        scrollToTopBtn.title = 'Lên đầu trang';
        scrollToTopBtn.innerHTML = '⬆️';
        document.body.appendChild(scrollToTopBtn);

        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        });

        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
            applyTheme(savedTheme);
            loadState();
        });

    </script>
</body>
</html>

