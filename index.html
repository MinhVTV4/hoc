<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnPath AI - (v12: L∆∞u ti·∫øn tr√¨nh)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMQNogNJeASiX9UrxmoL2ACafVVfk5TBccNsB6SbAtUWWl0ES" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; color: #212529; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 850px; }
        h1, h2 { color: #0056b3; text-align: center; margin-bottom: 5px; }
        h1 { font-size: 2.2rem; }
        h2 { font-size: 1.2rem; font-weight: 400; margin-bottom: 30px;}
        #controls { margin-bottom: 30px; background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #dee2e6; }
        input[type="text"] { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ced4da; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        input[type="text"]:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        button { width: 100%; padding: 14px 25px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 17px; transition: background-color 0.3s ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; }
        button:hover { background-color: #0056b3; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #a0c3e6; cursor: not-allowed; opacity: 0.9; }
        #clearProgressButton { background-color: #6c757d; margin-top: 10px; }
        #clearProgressButton:hover { background-color: #5a6268; }
        #responseContainer { background-color: #fff; border-radius: 12px; min-height: 100px; width: 100%; padding: 15px; box-sizing: border-box; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #dee2e6; }
        .learning-path ol { list-style-type: none; padding-left: 0; margin: 0; counter-reset: lesson-counter; }
        .learning-path li { background-color: #f8f9fa; margin-bottom: 10px; padding: 15px 20px 15px 50px; border-radius: 8px; border-left: 5px solid #6c757d; counter-increment: lesson-counter; position: relative; transition: all 0.3s ease; }
        .learning-path li[data-state="locked"] { background-color: #e9ecef; border-left-color: #adb5bd; cursor: not-allowed; opacity: 0.7; }
        .learning-path li[data-state="unlocked"] { border-left-color: #007bff; cursor: pointer; }
        .learning-path li[data-state="unlocked"]:hover { background-color: #e2e6ea; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .learning-path li[data-state="completed"] { border-left-color: #28a745; background-color: #e6f7ec; cursor: pointer; }
        .learning-path li::before { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background-color: #6c757d; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: monospace; font-size: 1.2rem; content: "üîí"; }
        .learning-path li[data-state="unlocked"]::before { background-color: #007bff; content: counter(lesson-counter); }
        .learning-path li[data-state="completed"]::before { background-color: #28a745; content: "‚úì"; }
        .lesson-title { font-weight: 500; font-size: 1.05rem;}
        .learning-path li.active { border-left-color: #fd7e14; }
        .learning-path li.active::before { background-color: #fd7e14; }
        .learning-path li[data-state="completed"].active { border-left-color: #198754; }
        .learning-path li[data-state="completed"].active::before { background-color: #198754; }
        .lesson-detail { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; }
        .learning-path li.active .lesson-detail { display: block; }
        .lesson-block { background-color: #fff; border: 1px solid #e9ecef; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .lesson-block-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .lesson-block.explanation { border-left: 4px solid #17a2b8; }
        .lesson-block.explanation .lesson-block-title { color: #17a2b8; }
        .lesson-block.example { border-left: 4px solid #ffc107; background-color: #fffbeb; }
        .lesson-block.example .lesson-block-title { color: #d39e00; }
        .lesson-block.note { border-left: 4px solid #6f42c1; background-color: #f4f0ff; }
        .lesson-block.note .lesson-block-title { color: #6f42c1; }
        .summary-quiz-title { font-size: 1.3rem; font-weight: 600; color: #d63384; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .practice-set .quiz-container { margin-bottom: 15px; }
        .practice-set .quiz-container:last-child { margin-bottom: 0; }
        .lesson-content { white-space: normal; word-wrap: break-word; line-height: 1.7; }
        .lesson-content p { margin-top: 0; margin-bottom: 1rem; }
        .lesson-content ul, .lesson-content ol { padding-left: 20px; }
        .lesson-content li { margin-bottom: 0.5rem; }
        .lesson-content strong { color: #0056b3; }
        .lesson-content code { background-color: #e9ecef; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        .status-message { margin-top: 15px; font-weight: bold; font-size: 0.95rem; text-align: center; width: 100%; }
        .status-message.error-text { color: #dc3545; }
        .status-message.success-text { color: #28a745; }
        .status-message.info-text { color: #17a2b8; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        button.loading .spinner { display: block; }
        .large-spinner, .small-spinner { border-radius: 50%; animation: spin 1.2s linear infinite; margin: auto; }
        .large-spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #007bff;}
        .small-spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff;}
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .quiz-container { background-color: #f0f7ff; border: 1px solid #b3d7ff; border-radius: 8px; padding: 20px; }
        .quiz-container p { margin-top: 0; font-weight: bold; }
        .quiz-options button { display: block; width: 100%; text-align: left; margin-bottom: 10px; background-color: #fff; color: #333; border: 1px solid #ced4da; }
        .quiz-options button:hover:not(:disabled) { background-color: #e9ecef; }
        .quiz-tf-options { display: flex; gap: 10px; }
        .quiz-tf-options button { flex: 1; text-align: center; }
        .quiz-container button.correct { background-color: #d4edda; border-color: #c3e6cb; color: #155724; font-weight: bold; }
        .quiz-container button.incorrect { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .quiz-feedback { margin-top: 15px; padding: 10px; border-radius: 6px; display: none; }
        .quiz-feedback.visible { display: block; }
        .quiz-feedback.correct { background-color: #d4edda; color: #155724; }
        .quiz-feedback.incorrect { background-color: #f8d7da; color: #721c24; }
        .quiz-fib-input { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin: 0 5px; }
        .check-fib-btn { width: auto; font-size: 15px; padding: 8px 16px; margin-left: 10px; }
        .retry-button { background-color: #6c757d; font-size: 14px; padding: 10px 20px; margin-top: 10px; width: auto; }
        .retry-button:hover { background-color: #5a6268; }
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5em 0; }
        #welcomeMessage { display: none; background-color: #e7f3ff; border-left: 5px solid #007bff; border-radius: 8px; padding: 20px; margin-bottom: 25px; line-height: 1.6; }
        #welcomeMessage p { margin: 0; }
        #welcomeMessage .small-spinner { margin: 0; display: inline-block; vertical-align: middle; margin-right: 10px;}
    </style>
</head>
<body>
    <div class="container">
        <h1>LearnPath AI üöÄ</h1>
        <h2>(v12: L∆∞u ti·∫øn tr√¨nh)</h2>

        <div id="controls">
            <input type="text" id="topicInput" placeholder="V√≠ d·ª•: ƒê·ªãnh l√Ω Pythagoras">
            <button id="generatePathButton">
                <span class="button-text">T·∫°o L·ªô tr√¨nh</span>
                <div class="spinner"></div>
            </button>
            <button id="clearProgressButton">X√≥a ti·∫øn tr√¨nh</button>
            <p id="statusMessage" class="status-message"></p>
        </div>
        
        <div id="welcomeMessage"></div>

        <h2>L·ªô tr√¨nh h·ªçc ƒë·ªÅ xu·∫•t:</h2>
        <div id="responseContainer">Ch∆∞a c√≥ l·ªô tr√¨nh n√†o ƒë∆∞·ª£c t·∫°o...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        
        const LS_KEY = 'learningPathState';

        function saveState() {
            const topic = topicInput.value.trim();
            const pathHTML = responseContainer.innerHTML;
            if (topic && pathHTML && pathHTML !== 'Ch∆∞a c√≥ l·ªô tr√¨nh n√†o ƒë∆∞·ª£c t·∫°o...') {
                const state = { topic, pathHTML };
                localStorage.setItem(LS_KEY, JSON.stringify(state));
                console.log("Ti·∫øn tr√¨nh ƒë√£ ƒë∆∞·ª£c l∆∞u!");
            }
        }

        function markStepAsCompleted(quizElement) {
            const currentLi = quizElement.closest('li');
            if (!currentLi || currentLi.dataset.state === 'completed') return;
            currentLi.dataset.state = 'completed';
            const nextLi = currentLi.nextElementSibling;
            if (nextLi && nextLi.dataset.state === 'locked') {
                nextLi.dataset.state = 'unlocked';
            }
            saveState(); // L∆∞u sau khi ho√†n th√†nh
        }
        
        function renderKatexInElement(element) {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true} ],
                    throwOnError: false
                });
            }
        }

        const toolImplementations = {
            createMultipleChoiceQuiz(args, container) {
                const { question, options, correctAnswerIndex, explanation } = args;
                if (!container) return;
                container.innerHTML = `<p>${question}</p><div class="quiz-options">${options.map((o, i) => `<button data-index="${i}">${o}</button>`).join('')}</div><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.quiz-options').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn || btn.parentElement.querySelector(':disabled')) return;
                    const selected = parseInt(btn.dataset.index);
                    const isCorrect = selected === correctAnswerIndex;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    feedbackEl.textContent = explanation;
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    renderKatexInElement(feedbackEl);
                    container.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        if (parseInt(b.dataset.index) === correctAnswerIndex) b.classList.add('correct');
                        else if (parseInt(b.dataset.index) === selected) b.classList.add('incorrect');
                    });
                    markStepAsCompleted(container);
                });
            },
            createFillInTheBlankQuiz(args, container) {
                const { sentence, correctAnswer, explanation } = args;
                if (!container) return;
                container.innerHTML = `<p>${sentence.replace("___", `<input type="text" class="quiz-fib-input" placeholder="...">`)}</p><button class="check-fib-btn">Ki·ªÉm tra</button><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.check-fib-btn').addEventListener('click', () => {
                    const input = container.querySelector('input');
                    const isCorrect = input.value.trim().toLowerCase() === correctAnswer.toLowerCase();
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    input.disabled = true;
                    container.querySelector('.check-fib-btn').disabled = true;
                    feedbackEl.innerHTML = `<strong>Gi·∫£i th√≠ch:</strong> ${explanation}`;
                    renderKatexInElement(feedbackEl);
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    input.classList.add(isCorrect ? 'correct' : 'incorrect');
                    if (!isCorrect) input.value += ` (ƒê√∫ng: ${correctAnswer})`;
                    markStepAsCompleted(container);
                });
            },
            createTrueFalseQuiz(args, container) {
                const { statement, isCorrect, explanation } = args;
                if (!container) return;
                container.innerHTML = `<p>${statement}</p><div class="quiz-tf-options"><button data-answer="true">ƒê√∫ng</button><button data-answer="false">Sai</button></div><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.quiz-tf-options').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn || btn.parentElement.querySelector(':disabled')) return;
                    const answer = btn.dataset.answer === 'true';
                    const isCorrectAnswer = answer === isCorrect;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    feedbackEl.textContent = explanation;
                    renderKatexInElement(feedbackEl);
                    feedbackEl.className = `quiz-feedback visible ${isCorrectAnswer ? 'correct' : 'incorrect'}`;
                    container.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        if ((b.dataset.answer === 'true') === isCorrect) b.classList.add('correct');
                    });
                    if (!isCorrectAnswer) btn.classList.add('incorrect');
                    markStepAsCompleted(container);
                });
            }
        };

        const firebaseConfig = {
            apiKey: "AIzaSyC3fY7kRz2P9BBIBd_jr7b3z5ZUpG5JH8g",
            authDomain: "cboxauto-minh.firebaseapp.com",
            projectId: "cboxauto-minh",
            storageBucket: "cboxauto-minh.appspot.com",
            messagingSenderId: "476350924183",
            appId: "1:476350924183:web:d40a9da3c8902e1d7230d2"
        };
        const app = initializeApp(firebaseConfig);
        const topicInput = document.getElementById('topicInput');
        const generatePathButton = document.getElementById('generatePathButton');
        const clearProgressButton = document.getElementById('clearProgressButton');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');

        function updateStatus(type, message) { statusMessage.className = `status-message ${type}`; statusMessage.innerHTML = message; }
        function toggleButtonLoading(isLoading) { const btnTxt = generatePathButton.querySelector('.button-text'); generatePathButton.disabled = isLoading; generatePathButton.classList.toggle('loading', isLoading); btnTxt.textContent = isLoading ? 'ƒêang t·∫°o...' : 'T·∫°o L·ªô tr√¨nh'; }
        
        function parseAiJson(text) {
            const match = text.match(/```(json)?\s*([\s\S]*?)\s*```/); 
            let jsonString = text;
            if (match && match[2]) {
                jsonString = match[2].trim();
            } else {
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace > firstBrace) {
                    jsonString = text.substring(firstBrace, lastBrace + 1);
                }
            }
            try { return JSON.parse(jsonString); } catch (e) {
                console.warn("L·ªói JSON parse l·∫ßn 1, th·ª≠ s·ª≠a l·ªói...", e);
                const repairedString = jsonString.replace(/,\s*([}\]])/g, '$1');
                try { return JSON.parse(repairedString); } catch (finalError) {
                     console.error("Kh√¥ng th·ªÉ s·ª≠a v√† parse JSON:", finalError);
                     throw new Error("D·ªØ li·ªáu JSON t·ª´ AI kh√¥ng h·ª£p l·ªá.");
                }
            }
        }

        let model;
        try {
            model = getGenerativeModel(getAI(app), { model: "gemini-2.5-flash" }); 
            updateStatus('success-text', "M√¥ h√¨nh AI ƒë√£ s·∫µn s√†ng!");
        } catch (e) {
            console.error("L·ªói kh·ªüi t·∫°o AI Model:", e);
            updateStatus('error-text', `L·ªói kh·ªüi t·∫°o AI Model: ${e.message}.`);
        }
        
        async function getLessonDetail(topic, detailElement) {
            if (!model) { detailElement.innerHTML = `<p class="error">M√¥ h√¨nh AI ch∆∞a s·∫µn s√†ng.</p>`; return; }
            detailElement.innerHTML = '<div class="small-spinner"></div>';
            
            const prompt = `B·∫°n l√† m·ªôt gia s∆∞ AI chuy√™n nghi·ªáp, chuy√™n t·∫°o n·ªôi dung gi√°o d·ª•c c√≥ ch·ª©a c√¥ng th·ª©c to√°n h·ªçc. H√£y t·∫°o m·ªôt b√†i h·ªçc ho√†n ch·ªânh v·ªÅ ch·ªß ƒë·ªÅ: "${topic}". Ch·ªâ tr·∫£ l·ªùi b·∫±ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON h·ª£p l·ªá duy nh·∫•t. Y√äU C·∫¶U C·ª∞C K·ª≤ QUAN TR·ªåNG V·ªÄ JSON: 1.  ƒê√¢y l√† quy t·∫Øc quan tr·ªçng nh·∫•t: M·ªçi k√Ω t·ª± backslash "\\" trong c√°c chu·ªói JSON ph·∫£i ƒë∆∞·ª£c escape ƒë√∫ng c√°ch. V√≠ d·ª•, ƒë·ªÉ vi·∫øt c√¥ng th·ª©c LaTeX "\\frac{a}{b}", b·∫°n PH·∫¢I vi·∫øt n√≥ th√†nh "\\\\frac{a}{b}" trong chu·ªói JSON. 2.  S·ª≠ d·ª•ng c√∫ ph√°p KaTeX cho t·∫•t c·∫£ c√°c c√¥ng th·ª©c to√°n h·ªçc. Inline math d√πng $, display math d√πng $$. 3.  N·ªôi dung trong tr∆∞·ªùng "content" ph·∫£i l√† vƒÉn b·∫£n ƒë·ªãnh d·∫°ng Markdown. 4.  ƒê·∫£m b·∫£o to√†n b·ªô ph·∫£n h·ªìi l√† m·ªôt kh·ªëi JSON h·ª£p l·ªá, kh√¥ng c√≥ vƒÉn b·∫£n n√†o kh√°c bao quanh. C·∫•u tr√∫c JSON ph·∫£i nh∆∞ sau: { "lessonTitle": "...", "introduction": "...", "contentBlocks": [ { "type": "explanation", "title": "...", "content": "..." }, { "type": "example", "title": "V√≠ d·ª• v·ªÅ c√¥ng th·ª©c...", "content": "C√¥ng th·ª©c t√≠nh di·ªán t√≠ch h√¨nh tr√≤n l√† $A = \\\\pi r^2$. M·ªôt v√≠ d·ª• kh√°c l√† ph∆∞∆°ng tr√¨nh b·∫≠c hai: $$x = \\\\frac{-b \\\\pm \\\\sqrt{b^2-4ac}}{2a}$$" }, { "type": "note", "title": "...", "content": "..." } ], "practiceSet": { "exercises": [ { "type": "createMultipleChoiceQuiz", "details": { "question": "...", "options": [...], "correctAnswerIndex": ..., "explanation": "..." }}, { "type": "createTrueFalseQuiz", "details": { "statement": "...", "isCorrect": ..., "explanation": "..." }} ] } }`;
            
            try {
                const result = await model.generateContent(prompt);
                const rawText = result.response.text();
                const lessonData = parseAiJson(rawText);
                renderStructuredLesson(lessonData, detailElement);
                saveState(); // L∆∞u sau khi t·∫£i chi ti·∫øt b√†i h·ªçc th√†nh c√¥ng
            } catch (error) {
                console.error("L·ªói khi l·∫•y chi ti·∫øt b√†i h·ªçc:", error);
                detailElement.innerHTML = `<p class="status-message error-text">Kh√¥ng th·ªÉ t·∫£i n·ªôi dung. V·∫•n ƒë·ªÅ c√≥ th·ªÉ do d·ªØ li·ªáu t·ª´ AI kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.</p><button class="retry-button">Th·ª≠ l·∫°i</button>`;
                detailElement.querySelector('.retry-button').addEventListener('click', () => getLessonDetail(topic, detailElement));
            }
        }

        function renderStructuredLesson(data, parentElement) {
            parentElement.innerHTML = ''; 
            if (data.introduction) {
                const introBlock = document.createElement('div');
                introBlock.className = 'lesson-block explanation';
                introBlock.innerHTML = `<div class="lesson-block-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20Z"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg><span>${data.lessonTitle || 'Gi·ªõi thi·ªáu'}</span></div><div class="lesson-content">${marked.parse(data.introduction)}</div>`;
                parentElement.appendChild(introBlock);
            }
            if (data.contentBlocks && Array.isArray(data.contentBlocks)) {
                data.contentBlocks.forEach(block => {
                    const blockEl = document.createElement('div');
                    blockEl.className = `lesson-block ${block.type || 'explanation'}`;
                    blockEl.innerHTML = `<div class="lesson-block-title">${getIconForBlockType(block.type)}<span>${block.title}</span></div><div class="lesson-content">${marked.parse(block.content)}</div>`;
                    parentElement.appendChild(blockEl);
                });
            }
            renderKatexInElement(parentElement);
            if (data.practiceSet && data.practiceSet.exercises) {
                renderSummaryQuiz(data.practiceSet, parentElement);
            }
        }
        
        function getIconForBlockType(type) {
            switch(type) { case 'example': return `üí°`; case 'note': return `üìå`; case 'explanation': default: return `üß†`; }
        }

        function renderSummaryQuiz(practiceSetData, parentElement) {
            const block = document.createElement('div');
            block.className = 'practice-set';
            block.innerHTML = `<div class="summary-quiz-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg><span>B√†i t·∫≠p t·ªïng k·∫øt</span></div>`;
            parentElement.appendChild(block);
            practiceSetData.exercises.forEach(exercise => {
                const exerciseContainer = document.createElement('div');
                exerciseContainer.className = 'quiz-container';
                block.appendChild(exerciseContainer);
                if (toolImplementations[exercise.type]) {
                    toolImplementations[exercise.type](exercise.details, exerciseContainer);
                }
            });
        }

        async function generateLearningPath() {
             if (!model) { updateStatus('error-text', "M√¥ h√¨nh AI ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o."); return; }
             const topic = topicInput.value.trim();
             if (!topic) { updateStatus('error-text', "Vui l√≤ng nh·∫≠p m·ªôt ch·ªß ƒë·ªÅ!"); return; }
             updateStatus('info-text', `ƒêang t·∫°o l·ªô tr√¨nh...`);
             responseContainer.innerHTML = '<div class="large-spinner"></div>';
             toggleButtonLoading(true);
             const prompt = `T·∫°o m·ªôt l·ªô tr√¨nh h·ªçc 5 b∆∞·ªõc cho ch·ªß ƒë·ªÅ: "${topic}". Tr·∫£ l·ªùi b·∫±ng JSON h·ª£p l·ªá: {"learningPath": ["B∆∞·ªõc 1", "B∆∞·ªõc 2", ...]}`;
             try {
                const result = await model.generateContent(prompt);
                const pathData = parseAiJson(result.response.text());
                const pathItems = pathData.learningPath;
                if (!Array.isArray(pathItems) || pathItems.length === 0) throw new Error("Invalid path data");
                responseContainer.innerHTML = `<div class="learning-path"><ol>${pathItems.map((item, index) => `<li data-topic="${item.replace(/"/g, '&quot;')}" data-state="${index === 0 ? 'unlocked' : 'locked'}"><span class="lesson-title">${item}</span><div class="lesson-detail"></div></li>`).join('')}</ol></div>`;
                updateStatus('success-text', "ƒê√£ t·∫°o l·ªô tr√¨nh! Nh·∫•p v√†o m·ª•c ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu.");
                saveState(); // L∆∞u sau khi t·∫°o l·ªô tr√¨nh th√†nh c√¥ng
             } catch (error) {
                console.error("L·ªói khi t·∫°o l·ªô tr√¨nh:", error);
                responseContainer.innerHTML = `<p class="status-message error-text">Kh√¥ng th·ªÉ t·∫°o l·ªô tr√¨nh. Vui l√≤ng th·ª≠ l·∫°i.</p>`;
                updateStatus('error-text', `L·ªói: ${error.message}`);
             } finally {
                toggleButtonLoading(false);
             }
        }

        responseContainer.addEventListener('click', async (event) => {
            const li = event.target.closest('li');
            if (!li) return;
            if (li.dataset.state === 'locked') { li.style.animation = 'shake 0.5s'; setTimeout(() => li.style.animation = '', 500); return; }
            if (event.target.closest('.quiz-container') || event.target.classList.contains('retry-button')) return;
            const wasActive = li.classList.contains('active');
            responseContainer.querySelectorAll('li').forEach(item => item.classList.remove('active'));
            if (!wasActive) {
                li.classList.add('active');
                const detailEl = li.querySelector('.lesson-detail');
                if (detailEl && detailEl.innerHTML === '') {
                    await getLessonDetail(li.dataset.topic, detailEl);
                }
            }
            saveState(); // L∆∞u sau m·ªói l·∫ßn nh·∫•p chu·ªôt (thay ƒë·ªïi active)
        });

        generatePathButton.addEventListener("click", generateLearningPath);

        // --- C√ÅC H√ÄM M·ªöI CHO VI·ªÜC L∆ØU/T·∫¢I TI·∫æN TR√åNH ---
        
        async function generateWelcomeBackMessage(mainTopic, lastLessonTopic) {
            if (!model || !lastLessonTopic) return;
            const welcomeContainer = document.getElementById('welcomeMessage');
            welcomeContainer.style.display = 'block';
            welcomeContainer.innerHTML = `<div class="small-spinner"></div> <p>AI ƒëang vi·∫øt l·ªùi ch√†o m·ª´ng...</p>`;

            const prompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω h·ªçc t·∫≠p AI th√¢n thi·ªán. Ng∆∞·ªùi d√πng v·ª´a quay l·∫°i ·ª©ng d·ª•ng h·ªçc t·∫≠p. H√£y t·∫°o m·ªôt l·ªùi ch√†o m·ª´ng ng·∫Øn g·ªçn (2-3 c√¢u), th√¢n thi·ªán v√† kh√≠ch l·ªá ƒë·ªÉ ch√†o h·ªç quay tr·ªü l·∫°i. - Ch·ªß ƒë·ªÅ ch√≠nh h·ªç ƒëang h·ªçc l√†: "${mainTopic}" - B√†i h·ªçc g·∫ßn nh·∫•t h·ªç xem l√†: "${lastLessonTopic}". G·ª£i √Ω cho h·ªç ti·∫øp t·ª•c h·ªçc t·ª´ b√†i ƒë√≥. Tr·∫£ l·ªùi b·∫±ng vƒÉn b·∫£n thu·∫ßn t√∫y, kh√¥ng d√πng Markdown hay JSON.`;

            try {
                const result = await model.generateContent(prompt);
                const message = result.response.text().replace(/\n/g, '<br>');
                welcomeContainer.innerHTML = `<p><strong>Tr·ª£ l√Ω AI:</strong> ${message}</p>`;
            } catch (error) {
                console.error("L·ªói t·∫°o l·ªùi ch√†o:", error);
                welcomeContainer.innerHTML = `<p>Ch√†o m·ª´ng b·∫°n ƒë√£ quay tr·ªü l·∫°i! H√£y c√πng ti·∫øp t·ª•c h·ªçc v·ªÅ <strong>${mainTopic}</strong> nh√©.</p>`;
            }
        }

        function loadState() {
            const savedStateJSON = localStorage.getItem(LS_KEY);
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    topicInput.value = savedState.topic;
                    responseContainer.innerHTML = savedState.pathHTML;
                    // Render l·∫°i KaTeX cho t·∫•t c·∫£ c√°c n·ªôi dung ƒë√£ t·∫£i
                    responseContainer.querySelectorAll('.lesson-content, .quiz-container').forEach(el => {
                        renderKatexInElement(el);
                    });
                    
                    const lastActiveLI = responseContainer.querySelector('li.active');
                    generateWelcomeBackMessage(savedState.topic, lastActiveLI?.dataset.topic);
                    updateStatus('success-text', 'ƒê√£ t·∫£i l·∫°i l·ªô tr√¨nh h·ªçc c·ªßa b·∫°n!');
                } catch(e) {
                    console.error("L·ªói khi t·∫£i ti·∫øn tr√¨nh:", e);
                    localStorage.removeItem(LS_KEY); // X√≥a d·ªØ li·ªáu h·ªèng
                }
            }
        }

        clearProgressButton.addEventListener('click', () => {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ ti·∫øn tr√¨nh ƒë√£ l∆∞u?')) {
                localStorage.removeItem(LS_KEY);
                topicInput.value = '';
                responseContainer.innerHTML = 'Ch∆∞a c√≥ l·ªô tr√¨nh n√†o ƒë∆∞·ª£c t·∫°o...';
                document.getElementById('welcomeMessage').style.display = 'none';
                updateStatus('info-text', 'ƒê√£ x√≥a ti·∫øn tr√¨nh. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.');
            }
        });

        // T·∫£i ti·∫øn tr√¨nh khi trang ƒë∆∞·ª£c m·ªü
        document.addEventListener('DOMContentLoaded', loadState);

    </script>
</body>
</html>

