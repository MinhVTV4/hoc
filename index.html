<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnPath AI - (v13.4: T√πy ch·ªânh Tr√¨nh ƒë·ªô)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMQNogNJeASiX9UrxmoL2ACafVVfk5TBccNsB6SbAtUWWl0ES" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; color: #212529; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 850px; }
        h1, h2 { color: #0056b3; text-align: center; margin-bottom: 5px; }
        h1 { font-size: 2.2rem; }
        h2 { font-size: 1.2rem; font-weight: 400; margin-bottom: 30px;}
        #controls { margin-bottom: 30px; background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #dee2e6; }
        input[type="text"], select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ced4da; border-radius: 8px; box-sizing: border-box; font-size: 16px; background-color: #fff; }
        input[type="text"]:focus, select:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        button { width: 100%; padding: 14px 25px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 17px; transition: background-color 0.3s ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; }
        button:hover { background-color: #0056b3; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #a0c3e6; cursor: not-allowed; opacity: 0.9; }
        #clearProgressButton { background-color: #6c757d; margin-top: 10px; }
        #clearProgressButton:hover { background-color: #5a6268; }
        #responseContainer { background-color: #fff; border-radius: 12px; min-height: 100px; width: 100%; padding: 15px; box-sizing: border-box; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #dee2e6; }
        .learning-path ol { list-style-type: none; padding-left: 0; margin: 0; counter-reset: lesson-counter; }
        .learning-path li { background-color: #f8f9fa; margin-bottom: 10px; padding: 15px 20px 15px 50px; border-radius: 8px; border-left: 5px solid #6c757d; counter-increment: lesson-counter; position: relative; transition: all 0.3s ease; }
        .learning-path li[data-state="locked"] { background-color: #e9ecef; border-left-color: #adb5bd; cursor: not-allowed; opacity: 0.7; }
        .learning-path li[data-state="unlocked"] { border-left-color: #007bff; cursor: pointer; }
        .learning-path li[data-state="unlocked"]:hover { background-color: #e2e6ea; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .learning-path li[data-state="completed"] { border-left-color: #28a745; background-color: #e6f7ec; cursor: pointer; }
        .learning-path li::before { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background-color: #6c757d; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: monospace; font-size: 1.2rem; content: "üîí"; }
        .learning-path li[data-state="unlocked"]::before { background-color: #007bff; content: counter(lesson-counter); }
        .learning-path li[data-state="completed"]::before { background-color: #28a745; content: "‚úì"; }
        .lesson-title { font-weight: 500; font-size: 1.05rem;}
        .learning-path li.active { border-left-color: #fd7e14; }
        .learning-path li.active::before { background-color: #fd7e14; }
        .learning-path li[data-state="completed"].active { border-left-color: #198754; }
        .learning-path li[data-state="completed"].active::before { background-color: #198754; }
        .lesson-detail { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; }
        .learning-path li.active .lesson-detail { display: block; }
        .lesson-block { background-color: #fff; border: 1px solid #e9ecef; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .lesson-block-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .lesson-block.explanation { border-left: 4px solid #17a2b8; }
        .lesson-block.explanation .lesson-block-title { color: #17a2b8; }
        .lesson-block.example { border-left: 4px solid #ffc107; background-color: #fffbeb; }
        .lesson-block.example .lesson-block-title { color: #d39e00; }
        .lesson-block.note { border-left: 4px solid #6f42c1; background-color: #f4f0ff; }
        .lesson-block.note .lesson-block-title { color: #6f42c1; }
        .summary-quiz-title { font-size: 1.3rem; font-weight: 600; color: #d63384; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .practice-set .quiz-container { margin-bottom: 15px; }
        .practice-set .quiz-container:last-child { margin-bottom: 0; }
        .lesson-content { white-space: normal; word-wrap: break-word; line-height: 1.7; }
        .lesson-content p { margin-top: 0; margin-bottom: 1rem; }
        .lesson-content ul, .lesson-content ol { padding-left: 20px; }
        .lesson-content li { margin-bottom: 0.5rem; }
        .lesson-content strong { color: #0056b3; }
        .lesson-content code { background-color: #e9ecef; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        .status-message { margin-top: 15px; font-weight: bold; font-size: 0.95rem; text-align: center; width: 100%; }
        .status-message.error-text { color: #dc3545; }
        .status-message.success-text { color: #28a745; }
        .status-message.info-text { color: #17a2b8; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        button.loading .spinner { display: block; }
        .large-spinner, .small-spinner { border-radius: 50%; animation: spin 1.2s linear infinite; margin: auto; }
        .large-spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #007bff;}
        .small-spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff;}
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .quiz-container { background-color: #f0f7ff; border: 1px solid #b3d7ff; border-radius: 8px; padding: 20px; }
        .quiz-container p { margin-top: 0; font-weight: bold; }
        .quiz-options button { display: block; width: 100%; text-align: left; margin-bottom: 10px; background-color: #fff; color: #333; border: 1px solid #ced4da; }
        .quiz-options button:hover:not(:disabled) { background-color: #e9ecef; }
        .quiz-tf-options { display: flex; gap: 10px; }
        .quiz-tf-options button { flex: 1; text-align: center; }
        .quiz-container button.correct { background-color: #d4edda; border-color: #c3e6cb; color: #155724; font-weight: bold; }
        .quiz-container button.incorrect { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .quiz-feedback { margin-top: 15px; padding: 10px; border-radius: 6px; display: none; }
        .quiz-feedback.visible { display: block; }
        .quiz-feedback.correct { background-color: #d4edda; color: #155724; }
        .quiz-feedback.incorrect { background-color: #f8d7da; color: #721c24; }
        .quiz-fib-input { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin: 0 5px; }
        .check-fib-btn { width: auto; font-size: 15px; padding: 8px 16px; margin-left: 10px; }
        .retry-button { background-color: #6c757d; font-size: 14px; padding: 10px 20px; margin-top: 10px; width: auto; }
        .retry-button:hover { background-color: #5a6268; }
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5em 0; }
        .feedback-actions { margin-top: 12px; display: flex; gap: 10px; }
        .feedback-actions button { font-size: 14px; padding: 8px 12px; width: auto; }
        .reinforce-btn { background-color: #6f42c1; } .reinforce-btn:hover { background-color: #59369a; }
        .expand-btn { background-color: #17a2b8; } .expand-btn:hover { background-color: #138496; }
        #welcomeMessage { display: none; background-color: #e7f3ff; border-left: 5px solid #007bff; border-radius: 8px; padding: 20px; margin-bottom: 25px; line-height: 1.6; }
        #welcomeMessage p { margin: 0; }
        #welcomeMessage .small-spinner { margin: 0; display: inline-block; vertical-align: middle; margin-right: 10px;}
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 12px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: black; }
        .modal-header { padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: #0056b3; }
        .modal-body { line-height: 1.7; }
        .modal-body .prose { max-width: none; }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.1rem; margin-bottom: 20px; }
            #controls, #responseContainer { padding: 15px; }
            .learning-path li { padding: 12px 15px 12px 45px; }
            .learning-path li::before { width: 26px; height: 26px; left: 8px; }
            .lesson-block, .quiz-container { padding: 15px; }
            .modal-content { width: 95%; margin: 5% auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LearnPath AI üöÄ</h1>
        <h2>(v13.4: T√πy ch·ªânh Tr√¨nh ƒë·ªô)</h2>

        <div id="controls">
            <input type="text" id="topicInput" placeholder="V√≠ d·ª•: ƒê·ªãnh l√Ω Pythagoras">
            
            <label for="pathLengthSelect" style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057; font-size: 15px;">ƒê·ªô chi ti·∫øt c·ªßa l·ªô tr√¨nh:</label>
            <select id="pathLengthSelect">
                <option value="3 ƒë·∫øn 4 b∆∞·ªõc">T√≥m t·∫Øt (3-4 b∆∞·ªõc)</option>
                <option value="5 ƒë·∫øn 6 b∆∞·ªõc" selected>Ti√™u chu·∫©n (5-6 b∆∞·ªõc)</option>
                <option value="7 ƒë·∫øn 9 b∆∞·ªõc">Chi ti·∫øt (7-9 b∆∞·ªõc)</option>
            </select>
            
            <!-- NEW: Learner level selector -->
            <label for="learnerLevelSelect" style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057; font-size: 15px;">Tr√¨nh ƒë·ªô ng∆∞·ªùi h·ªçc:</label>
            <select id="learnerLevelSelect">
                <option value="ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu">Ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu</option>
                <option value="ng∆∞·ªùi c√≥ ki·∫øn th·ª©c c∆° b·∫£n" selected>Ng∆∞·ªùi c√≥ c∆° b·∫£n</option>
                <option value="ng∆∞·ªùi mu·ªën t√¨m hi·ªÉu n√¢ng cao">N√¢ng cao</option>
            </select>

            <button id="generatePathButton">
                <span class="button-text">T·∫°o L·ªô tr√¨nh</span>
                <div class="spinner"></div>
            </button>
            <button id="clearProgressButton">X√≥a ti·∫øn tr√¨nh</button>
            <p id="statusMessage" class="status-message"></p>
        </div>
        
        <div id="welcomeMessage"></div>

        <h2>L·ªô tr√¨nh h·ªçc ƒë·ªÅ xu·∫•t:</h2>
        <div id="responseContainer">Ch∆∞a c√≥ l·ªô tr√¨nh n√†o ƒë∆∞·ª£c t·∫°o...</div>
    </div>
    
    <div id="aiTutorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close">&times;</span>
                <h3 id="aiTutorModalTitle">Tr·ª£ l√Ω AI</h3>
            </div>
            <div id="aiTutorModalBody" class="modal-body">
                <p>N·ªôi dung s·∫Ω ƒë∆∞·ª£c t·∫£i ·ªü ƒë√¢y...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        
        const LS_KEY = 'learningPathState';

        function saveState() {
            const topic = topicInput.value.trim();
            const pathHTML = responseContainer.innerHTML;
            if (topic && pathHTML && pathHTML !== 'Ch∆∞a c√≥ l·ªô tr√¨nh n√†o ƒë∆∞·ª£c t·∫°o...') {
                const state = { topic, pathHTML };
                localStorage.setItem(LS_KEY, JSON.stringify(state));
                console.log("Ti·∫øn tr√¨nh ƒë√£ ƒë∆∞·ª£c l∆∞u!");
            }
        }

        function markStepAsCompleted(quizElement) {
            const currentLi = quizElement.closest('li');
            if (!currentLi || currentLi.dataset.state === 'completed') return;
            currentLi.dataset.state = 'completed';
            const nextLi = currentLi.nextElementSibling;
            if (nextLi && nextLi.dataset.state === 'locked') {
                nextLi.dataset.state = 'unlocked';
            }
            saveState(); 
        }
        
        function renderKatexInElement(element) {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true} ],
                    throwOnError: false
                });
            }
        }
        
        const aiTutorModal = document.getElementById('aiTutorModal');
        const aiTutorModalTitle = document.getElementById('aiTutorModalTitle');
        const aiTutorModalBody = document.getElementById('aiTutorModalBody');
        const modalCloseBtn = aiTutorModal.querySelector('.modal-close');

        function showTutorModal(title, content) {
            aiTutorModalTitle.textContent = title;
            aiTutorModalBody.innerHTML = content;
            aiTutorModal.style.display = 'block';
            renderKatexInElement(aiTutorModalBody);
        }
        
        function hideTutorModal() {
            aiTutorModal.style.display = 'none';
        }
        modalCloseBtn.onclick = hideTutorModal;
        window.onclick = (event) => {
            if (event.target == aiTutorModal) {
                hideTutorModal();
            }
        }

        const toolImplementations = {
            createMultipleChoiceQuiz(args, container) {
                const { question, options, correctAnswerIndex, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createMultipleChoiceQuiz';
                container.dataset.quizArgs = JSON.stringify(args);
                
                container.innerHTML = `<p>${question}</p><div class="quiz-options">${options.map((o, i) => `<button data-index="${i}">${o}</button>`).join('')}</div><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.quiz-options').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn || btn.parentElement.querySelector(':disabled')) return;
                    
                    const selected = parseInt(btn.dataset.index);
                    const isCorrect = selected === correctAnswerIndex;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    
                    let feedbackHTML = `<p>${explanation}</p><div class="feedback-actions"></div>`;
                    feedbackEl.innerHTML = feedbackHTML;

                    const actionsContainer = feedbackEl.querySelector('.feedback-actions');
                    if (isCorrect) {
                        actionsContainer.innerHTML = `<button class="expand-btn">M·ªü r·ªông ki·∫øn th·ª©c ‚ú®</button>`;
                        actionsContainer.querySelector('.expand-btn').onclick = () => requestExpansion(args);
                    } else {
                        actionsContainer.innerHTML = `<button class="reinforce-btn">C·ªßng c·ªë ki·∫øn th·ª©c ü§î</button>`;
                        actionsContainer.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, options[selected]);
                    }
                    
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    renderKatexInElement(feedbackEl);
                    container.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        if (parseInt(b.dataset.index) === correctAnswerIndex) b.classList.add('correct');
                        else if (parseInt(b.dataset.index) === selected) b.classList.add('incorrect');
                    });
                    markStepAsCompleted(container);
                });
            },
            createFillInTheBlankQuiz(args, container) {
                const { sentence, correctAnswer, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createFillInTheBlankQuiz';
                container.dataset.quizArgs = JSON.stringify(args);

                container.innerHTML = `<p>${sentence.replace("___", `<input type="text" class="quiz-fib-input" placeholder="...">`)}</p><button class="check-fib-btn">Ki·ªÉm tra</button><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.check-fib-btn').addEventListener('click', () => {
                    const input = container.querySelector('input');
                    const userAnswer = input.value.trim();
                    const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    
                    input.disabled = true;
                    container.querySelector('.check-fib-btn').disabled = true;
                    
                    let feedbackHTML = `<p><strong>Gi·∫£i th√≠ch:</strong> ${explanation}</p><div class="feedback-actions"></div>`;
                    feedbackEl.innerHTML = feedbackHTML;
                    const actionsContainer = feedbackEl.querySelector('.feedback-actions');
                    if(isCorrect) {
                         actionsContainer.innerHTML = `<button class="expand-btn">M·ªü r·ªông ki·∫øn th·ª©c ‚ú®</button>`;
                         actionsContainer.querySelector('.expand-btn').onclick = () => requestExpansion(args);
                    } else {
                        actionsContainer.innerHTML = `<button class="reinforce-btn">C·ªßng c·ªë ki·∫øn th·ª©c ü§î</button>`;
                        actionsContainer.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, userAnswer);
                    }
                    
                    renderKatexInElement(feedbackEl);
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    input.classList.add(isCorrect ? 'correct' : 'incorrect');
                    if (!isCorrect) input.value += ` (ƒê√∫ng: ${correctAnswer})`;
                    markStepAsCompleted(container);
                });
            },
            createTrueFalseQuiz(args, container) {
                const { statement, isCorrect, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createTrueFalseQuiz';
                container.dataset.quizArgs = JSON.stringify(args);

                container.innerHTML = `<p>${statement}</p><div class="quiz-tf-options"><button data-answer="true">ƒê√∫ng</button><button data-answer="false">Sai</button></div><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.quiz-tf-options').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn || btn.parentElement.querySelector(':disabled')) return;
                    
                    const answer = btn.dataset.answer === 'true';
                    const isCorrectAnswer = answer === isCorrect;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    
                    let feedbackHTML = `<p>${explanation}</p><div class="feedback-actions"></div>`;
                    feedbackEl.innerHTML = feedbackHTML;
                    const actionsContainer = feedbackEl.querySelector('.feedback-actions');
                     if(isCorrectAnswer) {
                         actionsContainer.innerHTML = `<button class="expand-btn">M·ªü r·ªông ki·∫øn th·ª©c ‚ú®</button>`;
                         actionsContainer.querySelector('.expand-btn').onclick = () => requestExpansion(args);
                    } else {
                        actionsContainer.innerHTML = `<button class="reinforce-btn">C·ªßng c·ªë ki·∫øn th·ª©c ü§î</button>`;
                        actionsContainer.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, answer ? 'ƒê√∫ng' : 'Sai');
                    }
                    
                    renderKatexInElement(feedbackEl);
                    feedbackEl.className = `quiz-feedback visible ${isCorrectAnswer ? 'correct' : 'incorrect'}`;
                    container.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        if ((b.dataset.answer === 'true') === isCorrect) b.classList.add('correct');
                    });
                    if (!isCorrectAnswer) btn.classList.add('incorrect');
                    markStepAsCompleted(container);
                });
            }
        };

        const firebaseConfig = {
            apiKey: "AIzaSyC3fY7kRz2P9BBIBd_jr7b3z5ZUpG5JH8g",
            authDomain: "cboxauto-minh.firebaseapp.com",
            projectId: "cboxauto-minh",
            storageBucket: "cboxauto-minh.appspot.com",
            messagingSenderId: "476350924183",
            appId: "1:476350924183:web:d40a9da3c8902e1d7230d2"
        };
        const app = initializeApp(firebaseConfig);
        const topicInput = document.getElementById('topicInput');
        const generatePathButton = document.getElementById('generatePathButton');
        const clearProgressButton = document.getElementById('clearProgressButton');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');

        function updateStatus(type, message) { statusMessage.className = `status-message ${type}`; statusMessage.innerHTML = message; }
        function toggleButtonLoading(isLoading) { const btnTxt = generatePathButton.querySelector('.button-text'); generatePathButton.disabled = isLoading; generatePathButton.classList.toggle('loading', isLoading); btnTxt.textContent = isLoading ? 'ƒêang t·∫°o...' : 'T·∫°o L·ªô tr√¨nh'; }
        
        function parseAiJson(text) {
            const match = text.match(/```(json)?\s*([\s\S]*?)\s*```/); 
            let jsonString = text;
            if (match && match[2]) {
                jsonString = match[2].trim();
            } else {
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace > firstBrace) {
                    jsonString = text.substring(firstBrace, lastBrace + 1);
                }
            }
            try { return JSON.parse(jsonString); } catch (e) {
                console.warn("L·ªói JSON parse l·∫ßn 1, th·ª≠ s·ª≠a l·ªói...", e);
                const repairedString = jsonString.replace(/,\s*([}\]])/g, '$1');
                try { return JSON.parse(repairedString); } catch (finalError) {
                     console.error("Kh√¥ng th·ªÉ s·ª≠a v√† parse JSON:", finalError);
                     throw new Error("D·ªØ li·ªáu JSON t·ª´ AI kh√¥ng h·ª£p l·ªá.");
                }
            }
        }
        
        const quizTools = [{ 
            functionDeclarations: [
                { name: 'createMultipleChoiceQuiz', description: 'T·∫°o m·ªôt c√¢u h·ªèi tr·∫Øc nghi·ªám.', parameters: { type: 'OBJECT', properties: { question: { type: 'STRING' }, options: { type: 'ARRAY', items: { type: 'STRING' } }, correctAnswerIndex: { type: 'NUMBER' }, explanation: { type: 'STRING', description: 'Gi·∫£i th√≠ch ng·∫Øn g·ªçn t·∫°i sao ƒë√°p √°n l·∫°i ƒë√∫ng.' } }, required: ['question', 'options', 'correctAnswerIndex', 'explanation'] } },
                { name: 'createFillInTheBlankQuiz', description: 'T·∫°o m·ªôt c√¢u h·ªèi ƒëi·ªÅn v√†o ch·ªó tr·ªëng.', parameters: { type: 'OBJECT', properties: { sentence: { type: 'STRING', description: 'C√¢u ch·ª©a k√Ω hi·ªáu ___ cho ch·ªó tr·ªëng.' }, correctAnswer: { type: 'STRING' }, explanation: { type: 'STRING', description: 'Gi·∫£i th√≠ch ng·∫Øn g·ªçn t·∫°i sao ƒë√°p √°n l·∫°i ƒë√∫ng.' } }, required: ['sentence', 'correctAnswer', 'explanation'] } },
                { name: 'createTrueFalseQuiz', description: 'T·∫°o m·ªôt c√¢u h·ªèi d·∫°ng ƒê√∫ng ho·∫∑c Sai.', parameters: { type: 'OBJECT', properties: { statement: { type: 'STRING' }, isCorrect: { type: 'BOOLEAN' }, explanation: { type: 'STRING', description: 'Gi·∫£i th√≠ch ng·∫Øn g·ªçn t·∫°i sao ƒë√°p √°n l·∫°i ƒë√∫ng.' } }, required: ['statement', 'isCorrect', 'explanation'] } }
            ]
        }];

        let model;
        try {
            model = getGenerativeModel(getAI(app), { model: "gemini-2.5-flash" }); 
            updateStatus('success-text', "M√¥ h√¨nh AI ƒë√£ s·∫µn s√†ng!");
        } catch (e) {
            console.error("L·ªói kh·ªüi t·∫°o AI Model:", e);
            updateStatus('error-text', `L·ªói kh·ªüi t·∫°o AI Model: ${e.message}.`);
        }
        
        async function getLessonDetail(topic, detailElement) {
            if (!model) { detailElement.innerHTML = `<p class="error">M√¥ h√¨nh AI ch∆∞a s·∫µn s√†ng.</p>`; return; }
            detailElement.innerHTML = '<div class="small-spinner"></div>';
            
            const prompt = `B·∫°n l√† m·ªôt gia s∆∞ AI chuy√™n nghi·ªáp, chuy√™n t·∫°o n·ªôi dung gi√°o d·ª•c c√≥ c·∫•u tr√∫c. H√£y t·∫°o m·ªôt b√†i h·ªçc ho√†n ch·ªânh v·ªÅ ch·ªß ƒë·ªÅ: "${topic}".
            
            **QUY T·∫ÆC B·∫ÆT BU·ªòC V·ªÄ ƒê·ªäNH D·∫†NG:**
            1.  ƒê·ªëi v·ªõi T·∫§T C·∫¢ c√°c chu·ªói vƒÉn b·∫£n, bao g·ªìm n·ªôi dung trong kh·ªëi JSON v√† c√°c tham s·ªë c·ªßa 'tools' (nh∆∞ 'question', 'explanation'), m·ªçi c√¥ng th·ª©c to√°n h·ªçc PH·∫¢I d√πng c√∫ ph√°p KaTeX.
            2.  C√°c d·∫•u backslash ƒë∆°n '\\' PH·∫¢I ƒë∆∞·ª£c escape th√†nh '\\\\'. V√≠ d·ª•: c√¥ng th·ª©c $C = 2\\pi r$ ph·∫£i ƒë∆∞·ª£c vi·∫øt l√† "C = 2\\\\pi r" trong chu·ªói.
            
            **Y√äU C·∫¶U PH·∫¢N H·ªíI:**
            Ph·∫£n h·ªìi c·ªßa b·∫°n PH·∫¢I bao g·ªìm 2 ph·∫ßn:
            
            1.  **N·ªôi dung b√†i h·ªçc:** Cung c·∫•p ph·∫ßn n√†y trong m·ªôt kh·ªëi m√£ JSON h·ª£p l·ªá.
            \`\`\`json
            {
              "lessonTitle": "...",
              "introduction": "...",
              "contentBlocks": [
                { "type": "explanation", "title": "...", "content": "..." },
                { "type": "example", "title": "...", "content": "..." }
              ]
            }
            \`\`\`
            
            2.  **B√†i t·∫≠p th·ª±c h√†nh:** Ngay sau kh·ªëi JSON, h√£y s·ª≠ d·ª•ng c√°c c√¥ng c·ª• (tools) ƒë√£ ƒë∆∞·ª£c cung c·∫•p ƒë·ªÉ t·∫°o ra 2-3 c√¢u h·ªèi √¥n t·∫≠p li√™n quan tr·ª±c ti·∫øp ƒë·∫øn n·ªôi dung b√†i h·ªçc.`;
            
            try {
                const result = await model.generateContent({
                    contents: [{ role: 'user', parts: [{ text: prompt }] }],
                    tools: quizTools
                });

                const response = result.response;
                const rawText = response.text();
                
                const lessonData = parseAiJson(rawText);
                renderStructuredLesson(lessonData, detailElement);

                const functionCalls = response.functionCalls();
                if (functionCalls && functionCalls.length > 0) {
                    renderSummaryQuiz(functionCalls, detailElement);
                }
                
                saveState();
            } catch (error) {
                console.error("L·ªói khi l·∫•y chi ti·∫øt b√†i h·ªçc:", error);
                detailElement.innerHTML = `<p class="status-message error-text">Kh√¥ng th·ªÉ t·∫£i n·ªôi dung. V·∫•n ƒë·ªÅ c√≥ th·ªÉ do d·ªØ li·ªáu t·ª´ AI kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.</p><button class="retry-button">Th·ª≠ l·∫°i</button>`;
                detailElement.querySelector('.retry-button').addEventListener('click', () => getLessonDetail(topic, detailElement));
            }
        }

        function renderStructuredLesson(data, parentElement) {
            parentElement.innerHTML = ''; 
            if (data.introduction) {
                const introBlock = document.createElement('div');
                introBlock.className = 'lesson-block explanation';
                introBlock.innerHTML = `<div class="lesson-block-title">üß† <span>${data.lessonTitle || 'Gi·ªõi thi·ªáu'}</span></div><div class="lesson-content">${marked.parse(data.introduction)}</div>`;
                parentElement.appendChild(introBlock);
            }
            if (data.contentBlocks && Array.isArray(data.contentBlocks)) {
                data.contentBlocks.forEach(block => {
                    const blockEl = document.createElement('div');
                    blockEl.className = `lesson-block ${block.type || 'explanation'}`;
                    blockEl.innerHTML = `<div class="lesson-block-title">${getIconForBlockType(block.type)}<span>${block.title}</span></div><div class="lesson-content">${marked.parse(block.content)}</div>`;
                    parentElement.appendChild(blockEl);
                });
            }
            renderKatexInElement(parentElement);
        }
        
        function getIconForBlockType(type) {
            switch(type) { case 'example': return `üí°`; case 'note': return `üìå`; case 'explanation': default: return `üß†`; }
        }

        function renderSummaryQuiz(functionCalls, parentElement) {
            const block = document.createElement('div');
            block.className = 'practice-set';
            block.innerHTML = `<div class="summary-quiz-title">üìù <span>B√†i t·∫≠p t·ªïng k·∫øt</span></div>`;
            parentElement.appendChild(block);

            functionCalls.forEach(call => {
                const exerciseContainer = document.createElement('div');
                exerciseContainer.className = 'quiz-container';
                block.appendChild(exerciseContainer);
                
                const implementation = toolImplementations[call.name];
                if (implementation) {
                    implementation(call.args, exerciseContainer);
                } else {
                    console.warn(`Kh√¥ng t√¨m th·∫•y h√†m tri·ªÉn khai cho c√¥ng c·ª•: ${call.name}`);
                    exerciseContainer.textContent = `L·ªói: Kh√¥ng th·ªÉ hi·ªÉn th·ªã b√†i t·∫≠p lo·∫°i "${call.name}".`;
                }
            });
        }

        async function generateLearningPath() {
             if (!model) { updateStatus('error-text', "M√¥ h√¨nh AI ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o."); return; }
             const topic = topicInput.value.trim();
             if (!topic) { updateStatus('error-text', "Vui l√≤ng nh·∫≠p m·ªôt ch·ªß ƒë·ªÅ!"); return; }

             const pathLengthSelect = document.getElementById('pathLengthSelect');
             const pathLength = pathLengthSelect.value;
             
             // NEW: Get selected learner level
             const learnerLevelSelect = document.getElementById('learnerLevelSelect');
             const learnerLevel = learnerLevelSelect.value;

             updateStatus('info-text', `ƒêang t·∫°o l·ªô tr√¨nh...`);
             responseContainer.innerHTML = '<div class="large-spinner"></div>';
             toggleButtonLoading(true);

             // NEW: Update prompt with both length and level
             const prompt = `T·∫°o m·ªôt l·ªô tr√¨nh h·ªçc g·ªìm ${pathLength} r√µ r√†ng v√† tu·∫ßn t·ª± cho ch·ªß ƒë·ªÅ: "${topic}", ph√π h·ª£p v·ªõi tr√¨nh ƒë·ªô c·ªßa m·ªôt "${learnerLevel}". Ch·ªâ tr·∫£ l·ªùi b·∫±ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON h·ª£p l·ªá duy nh·∫•t, kh√¥ng c√≥ vƒÉn b·∫£n n√†o kh√°c. C·∫•u tr√∫c: {"learningPath": ["B∆∞·ªõc 1: Gi·ªõi thi·ªáu...", "B∆∞·ªõc 2: T√¨m hi·ªÉu s√¢u...", ...]}`;
             
             try {
                const result = await model.generateContent(prompt);
                const pathData = parseAiJson(result.response.text());
                const pathItems = pathData.learningPath;
                if (!Array.isArray(pathItems) || pathItems.length === 0) throw new Error("Invalid path data");
                responseContainer.innerHTML = `<div class="learning-path"><ol>${pathItems.map((item, index) => `<li data-topic="${item.replace(/"/g, '&quot;')}" data-state="${index === 0 ? 'unlocked' : 'locked'}"><span class="lesson-title">${item}</span><div class="lesson-detail"></div></li>`).join('')}</ol></div>`;
                updateStatus('success-text', "ƒê√£ t·∫°o l·ªô tr√¨nh! Nh·∫•p v√†o m·ª•c ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu.");
                saveState();
             } catch (error) {
                console.error("L·ªói khi t·∫°o l·ªô tr√¨nh:", error);
                responseContainer.innerHTML = `<p class="status-message error-text">Kh√¥ng th·ªÉ t·∫°o l·ªô tr√¨nh. Vui l√≤ng th·ª≠ l·∫°i.</p>`;
                updateStatus('error-text', `L·ªói: ${error.message}`);
             } finally {
                toggleButtonLoading(false);
             }
        }
        
        async function requestReinforcement(questionArgs, userAnswer) {
            showTutorModal("C·ªßng c·ªë ki·∫øn th·ª©c", '<div class="small-spinner"></div>');
            const questionText = questionArgs.question || questionArgs.statement;
            const correctAnswer = questionArgs.correctAnswer || (questionArgs.options ? questionArgs.options[questionArgs.correctAnswerIndex] : 'N/A');
            const prompt = `B·∫°n l√† m·ªôt gia s∆∞ AI t·∫≠n t√¨nh. M·ªôt h·ªçc sinh v·ª´a tr·∫£ l·ªùi SAI m·ªôt c√¢u h·ªèi. H√£y cung c·∫•p m·ªôt b√†i h·ªçc ng·∫Øn g·ªçn (b·∫±ng ti·∫øng Vi·ªát, d√πng Markdown) ƒë·ªÉ gi√∫p h·ªç hi·ªÉu r√µ l·ªói sai v√† c·ªßng c·ªë ki·∫øn th·ª©c.
            - **C√¢u h·ªèi:** "${questionText}"
            - **C√¢u tr·∫£ l·ªùi sai c·ªßa h·ªçc sinh:** "${userAnswer}"
            - **ƒê√°p √°n ƒë√∫ng:** "${correctAnswer}"
            
            B√†i h·ªçc c·ªßa b·∫°n n√™n c√≥:
            1.  **Ph√¢n t√≠ch l·ªói sai:** Gi·∫£i th√≠ch t·∫°i sao c√¢u tr·∫£ l·ªùi c·ªßa h·ªç ch∆∞a ƒë√∫ng.
            2.  **Gi·∫£i th√≠ch kh√°i ni·ªám:** Gi·∫£ng l·∫°i ng·∫Øn g·ªçn v·ªÅ ki·∫øn th·ª©c c·ªët l√µi.
            3.  **V√≠ d·ª• minh h·ªça:** Cung c·∫•p 1-2 v√≠ d·ª• kh√°c ƒë·ªÉ l√†m r√µ.`;
            try {
                const result = await model.generateContent(prompt);
                showTutorModal("C·ªßng c·ªë ki·∫øn th·ª©c", marked.parse(result.response.text()));
            } catch(e) { showTutorModal("L·ªói", "Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI ƒë·ªÉ t·∫°o b√†i h·ªçc."); }
        }

        async function requestExpansion(questionArgs) {
            showTutorModal("M·ªü r·ªông ki·∫øn th·ª©c", '<div class="small-spinner"></div>');
            const questionText = questionArgs.question || questionArgs.statement;
            const prompt = `B·∫°n l√† m·ªôt gia s∆∞ AI th√¢n thi·ªán. M·ªôt h·ªçc sinh v·ª´a tr·∫£ l·ªùi ƒê√öNG c√¢u h·ªèi sau: "${questionText}". 
            H√£y khen ng·ª£i h·ªç v√† cung c·∫•p m·ªôt m·∫©u ki·∫øn th·ª©c m·ªü r·ªông ng·∫Øn g·ªçn (b·∫±ng ti·∫øng Vi·ªát, d√πng Markdown) ƒë·ªÉ gi√∫p h·ªç hi·ªÉu s√¢u h∆°n v·ªÅ ch·ªß ƒë·ªÅ li√™n quan ho·∫∑c m·ªôt ·ª©ng d·ª•ng th√∫ v·ªã c·ªßa ki·∫øn th·ª©c ƒë√≥.`;
            try {
                const result = await model.generateContent(prompt);
                showTutorModal("M·ªü r·ªông ki·∫øn th·ª©c", marked.parse(result.response.text()));
            } catch(e) { showTutorModal("L·ªói", "Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI ƒë·ªÉ t·∫°o b√†i h·ªçc."); }
        }


        responseContainer.addEventListener('click', async (event) => {
            const li = event.target.closest('li');
            if (!li) return;
            if (li.dataset.state === 'locked') { li.style.animation = 'shake 0.5s'; setTimeout(() => li.style.animation = '', 500); return; }
            if (event.target.closest('.quiz-container') || event.target.closest('.feedback-actions') || event.target.classList.contains('retry-button')) return;
            
            const wasActive = li.classList.contains('active');
            responseContainer.querySelectorAll('li').forEach(item => item.classList.remove('active'));
            if (!wasActive) {
                li.classList.add('active');
                const detailEl = li.querySelector('.lesson-detail');
                if (detailEl && detailEl.innerHTML === '') {
                    await getLessonDetail(li.dataset.topic, detailEl);
                }
            }
            saveState();
        });

        generatePathButton.addEventListener("click", generateLearningPath);

        async function generateWelcomeBackMessage(mainTopic, lastLessonTopic) {
            if (!model || !lastLessonTopic) return;
            const welcomeContainer = document.getElementById('welcomeMessage');
            welcomeContainer.style.display = 'block';
            welcomeContainer.innerHTML = `<div class="small-spinner"></div> <p>AI ƒëang vi·∫øt l·ªùi ch√†o m·ª´ng...</p>`;

            const prompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω h·ªçc t·∫≠p AI th√¢n thi·ªán. Ng∆∞·ªùi d√πng v·ª´a quay l·∫°i ·ª©ng d·ª•ng h·ªçc t·∫≠p. H√£y t·∫°o m·ªôt l·ªùi ch√†o m·ª´ng ng·∫Øn g·ªçn (2-3 c√¢u), th√¢n thi·ªán v√† kh√≠ch l·ªá ƒë·ªÉ ch√†o h·ªç quay tr·ªü l·∫°i. - Ch·ªß ƒë·ªÅ ch√≠nh h·ªç ƒëang h·ªçc l√†: "${mainTopic}" - B√†i h·ªçc g·∫ßn nh·∫•t h·ªç xem l√†: "${lastLessonTopic}". G·ª£i √Ω cho h·ªç ti·∫øp t·ª•c h·ªçc t·ª´ b√†i ƒë√≥. Tr·∫£ l·ªùi b·∫±ng vƒÉn b·∫£n thu·∫ßn t√∫y, kh√¥ng d√πng Markdown hay JSON.`;

            try {
                const result = await model.generateContent(prompt);
                const message = result.response.text().replace(/\n/g, '<br>');
                welcomeContainer.innerHTML = `<p><strong>Tr·ª£ l√Ω AI:</strong> ${message}</p>`;
            } catch (error) {
                console.error("L·ªói t·∫°o l·ªùi ch√†o:", error);
                welcomeContainer.innerHTML = `<p>Ch√†o m·ª´ng b·∫°n ƒë√£ quay tr·ªü l·∫°i! H√£y c√πng ti·∫øp t·ª•c h·ªçc v·ªÅ <strong>${mainTopic}</strong> nh√©.</p>`;
            }
        }
        
        function rehydrateQuizzes() {
            responseContainer.querySelectorAll('.quiz-container').forEach(container => {
                const type = container.dataset.quizType;
                const argsJSON = container.dataset.quizArgs;
                
                const isAnswered = container.querySelector('button:disabled');

                if (type && argsJSON && toolImplementations[type] && !isAnswered) {
                    try {
                        const args = JSON.parse(argsJSON);
                        toolImplementations[type](args, container);
                    } catch (e) {
                        console.error("L·ªói khi rehydrate quiz:", e, container);
                    }
                }
            });
        }

        function loadState() {
            const savedStateJSON = localStorage.getItem(LS_KEY);
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    topicInput.value = savedState.topic;
                    responseContainer.innerHTML = savedState.pathHTML;
                    
                    responseContainer.querySelectorAll('.lesson-content, .quiz-container, .quiz-feedback').forEach(el => {
                        renderKatexInElement(el);
                    });
                    
                    rehydrateQuizzes();
                    
                    const lastActiveLI = responseContainer.querySelector('li.active');
                    generateWelcomeBackMessage(savedState.topic, lastActiveLI?.dataset.topic);
                    updateStatus('success-text', 'ƒê√£ t·∫£i l·∫°i l·ªô tr√¨nh h·ªçc c·ªßa b·∫°n!');
                } catch(e) {
                    console.error("L·ªói khi t·∫£i ti·∫øn tr√¨nh:", e);
                    localStorage.removeItem(LS_KEY); 
                }
            }
        }
        
        clearProgressButton.addEventListener('click', () => {
             const userConfirmed = window.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ ti·∫øn tr√¨nh ƒë√£ l∆∞u?');
            if (userConfirmed) {
                localStorage.removeItem(LS_KEY);
                topicInput.value = '';
                responseContainer.innerHTML = 'Ch∆∞a c√≥ l·ªô tr√¨nh n√†o ƒë∆∞·ª£c t·∫°o...';
                document.getElementById('welcomeMessage').style.display = 'none';
                updateStatus('info-text', 'ƒê√£ x√≥a ti·∫øn tr√¨nh. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.');
            }
        });

        document.addEventListener('DOMContentLoaded', loadState);

    </script>
</body>
</html>

