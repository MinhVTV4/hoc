<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnPath AI - (v15.6: Sửa lỗi KaTeX triệt để)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- FIX: Corrected all 'xintegrity' attributes to 'integrity' for security and stability. -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOVEMQNogNJeASiX9UrxmoL2ACafVVfk5TBccNsB6SbAtUWWl0ES" crossorigin="anonymous">
    <!-- FIX & UPGRADE: Added 'defer' for stable, non-blocking script loading. -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <!-- New Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            /* Light Theme */
            --bg-primary-light: #f4f5f7;
            --bg-secondary-light: #ffffff;
            --bg-tertiary-light: #f9fafb;
            --text-primary-light: #111827;
            --text-secondary-light: #4b5563;
            --border-light: #e5e7eb;
            --primary-light: #2563eb;
            --primary-hover-light: #1d4ed8;
            --accent-light: #f97316;
            --success-light: #16a34a;
            --danger-light: #dc2626;
            --danger-hover-light: #b91c1c;
            --shadow-light: rgba(0, 0, 0, 0.06);

            /* Dark Theme */
            --bg-primary-dark: #111827;
            --bg-secondary-dark: #1f2937;
            --bg-tertiary-dark: #374151;
            --text-primary-dark: #f9fafb;
            --text-secondary-dark: #9ca3af;
            --border-dark: #4b5563;
            --primary-dark: #38bdf8;
            --primary-hover-dark: #0ea5e9;
            --accent-dark: #fb923c;
            --success-dark: #4ade80;
            --danger-dark: #f87171;
            --danger-hover-dark: #ef4444;
            --shadow-dark: rgba(0, 0, 0, 0.2);
        }

        [data-theme="light"] {
            --bg-primary: var(--bg-primary-light);
            --bg-secondary: var(--bg-secondary-light);
            --bg-tertiary: var(--bg-tertiary-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --border: var(--border-light);
            --primary: var(--primary-light);
            --primary-hover: var(--primary-hover-light);
            --accent: var(--accent-light);
            --success: var(--success-light);
            --danger: var(--danger-light);
            --danger-hover: var(--danger-hover-light);
            --shadow: var(--shadow-light);
        }

        [data-theme="dark"] {
            --bg-primary: var(--bg-primary-dark);
            --bg-secondary: var(--bg-secondary-dark);
            --bg-tertiary: var(--bg-tertiary-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --border: var(--border-dark);
            --primary: var(--primary-dark);
            --primary-hover: var(--primary-hover-dark);
            --accent: var(--accent-dark);
            --success: var(--success-dark);
            --danger: var(--danger-dark);
            --danger-hover: var(--danger-hover-dark);
            --shadow: var(--shadow-dark);
        }

        html { scroll-behavior: smooth; }
        body { font-family: var(--font-main); margin: 0; padding: 20px; background-color: var(--bg-primary); color: var(--text-primary); display: flex; flex-direction: column; align-items: center; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 850px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .header-title { display: flex; align-items: center; gap: 12px; }
        .header-title span { font-size: 2.2rem; }
        .header-actions { display: flex; align-items: center; }
        #theme-toggle-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); width: 44px; height: 44px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; }
        #theme-toggle-btn:hover { background-color: var(--bg-tertiary); }
        h1, h2 { text-align: center; margin-bottom: 5px; }
        h1 { font-size: 2.2rem; color: var(--text-primary); }
        h2 { font-size: 1.2rem; font-weight: 400; margin-bottom: 30px; color: var(--text-secondary); }
        #controls { margin-bottom: 30px; background-color: var(--bg-secondary); padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--border); transition: background-color 0.3s, border-color 0.3s; }
        input[type="text"], select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 16px; background-color: var(--bg-secondary); color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; }
        input[type="text"]:focus, select:focus { border-color: var(--primary); outline: 0; box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); }
        button { width: 100%; padding: 14px 25px; background-color: var(--primary); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 17px; transition: background-color 0.3s ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; }
        button:hover { background-color: var(--primary-hover); }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.6; }
        #clearProgressButton { background-color: var(--bg-tertiary); color: var(--danger); border: 1px solid var(--danger); margin-top: 10px; }
        #clearProgressButton:hover { background-color: var(--danger); color: #fff; }
        #responseContainer { background-color: var(--bg-secondary); border-radius: 16px; min-height: 100px; width: 100%; padding: 25px; box-sizing: border-box; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--border); }
        
        /* UPGRADE: Improved empty state design */
        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-state svg { width: 60px; height: 60px; color: var(--primary); margin-bottom: 15px; }
        .empty-state h3 { font-size: 1.5rem; color: var(--text-primary); margin: 0 0 10px 0; }
        .empty-state p { font-size: 1rem; color: var(--text-secondary); margin: 0; }
        
        .learning-path ol { list-style-type: none; padding-left: 0; margin: 0; counter-reset: lesson-counter; }
        .learning-path li { background-color: var(--bg-tertiary); margin-bottom: 10px; padding: 15px 20px 15px 55px; border-radius: 12px; border-left: 5px solid var(--text-secondary); counter-increment: lesson-counter; position: relative; transition: all 0.3s ease; }
        .learning-path li[data-state="locked"] { background-color: color-mix(in srgb, var(--bg-tertiary) 50%, transparent); border-left-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }
        .learning-path li[data-state="unlocked"] { border-left-color: var(--primary); cursor: pointer; }
        .learning-path li[data-state="unlocked"]:hover { background-color: color-mix(in srgb, var(--bg-primary) 50%, var(--bg-secondary) 50%); box-shadow: 0 2px 5px var(--shadow); }
        .learning-path li[data-state="completed"] { border-left-color: var(--success); background-color: color-mix(in srgb, var(--success) 8%, var(--bg-secondary)); cursor: pointer; }
        .learning-path li::before { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); background-color: var(--text-secondary); color: var(--bg-secondary); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: monospace; font-size: 1.2rem; content: "🔒"; }
        .learning-path li[data-state="unlocked"]::before { background-color: var(--primary); content: counter(lesson-counter); }
        .learning-path li[data-state="completed"]::before { background-color: var(--success); content: "✓"; }
        .lesson-title { font-weight: 500; font-size: 1.05rem; color: var(--text-primary); }
        .learning-path li.active { border-left-color: var(--accent); }
        .learning-path li.active::before { background-color: var(--accent); }
        .learning-path li[data-state="completed"].active { border-left-color: color-mix(in srgb, var(--success) 80%, black); }
        .learning-path li[data-state="completed"].active::before { background-color: color-mix(in srgb, var(--success) 80%, black); }
        .lesson-detail { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .learning-path li.active .lesson-detail { display: block; }
        .lesson-block { background-color: var(--bg-secondary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .lesson-block-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .lesson-block.explanation { border-left: 4px solid #17a2b8; }
        .lesson-block.explanation .lesson-block-title { color: #17a2b8; }
        .lesson-block.example { border-left: 4px solid #ffc107; background-color: color-mix(in srgb, #ffc107 10%, var(--bg-secondary));}
        .lesson-block.example .lesson-block-title { color: #d39e00; }
        .lesson-block.note { border-left: 4px solid #6f42c1; background-color: color-mix(in srgb, #6f42c1 10%, var(--bg-secondary)); }
        .lesson-block.note .lesson-block-title { color: #6f42c1; }
        .summary-quiz-title { font-size: 1.3rem; font-weight: 600; color: #d63384; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .practice-set .quiz-container { margin-bottom: 15px; }
        .practice-set .quiz-container:last-child { margin-bottom: 0; }
        .lesson-content { white-space: normal; word-wrap: break-word; line-height: 1.7; color: var(--text-secondary); }
        .lesson-content p { margin-top: 0; margin-bottom: 1rem; }
        .lesson-content ul, .lesson-content ol { padding-left: 20px; }
        .lesson-content li { margin-bottom: 0.5rem; }
        .lesson-content strong { color: var(--text-primary); }
        .lesson-content code { background-color: var(--bg-tertiary); padding: 2px 6px; border-radius: 6px; font-family: monospace; border: 1px solid var(--border); }
        .status-message { margin-top: 15px; font-weight: bold; font-size: 0.95rem; text-align: center; width: 100%; }
        .status-message.error-text { color: var(--danger); }
        .status-message.success-text { color: var(--success); }
        .status-message.info-text { color: #17a2b8; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        button.loading .spinner { display: block; }
        .large-spinner, .small-spinner { border-radius: 50%; animation: spin 1.2s linear infinite; margin: auto; }
        .large-spinner { width: 50px; height: 50px; border: 5px solid var(--bg-tertiary); border-top: 5px solid var(--primary);}
        .small-spinner { width: 30px; height: 30px; border: 3px solid var(--bg-tertiary); border-top: 3px solid var(--primary);}
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .quiz-container { background-color: color-mix(in srgb, var(--primary) 8%, var(--bg-secondary)); border: 1px solid color-mix(in srgb, var(--primary) 20%, transparent); border-radius: 8px; padding: 20px; }
        .quiz-container p { margin-top: 0; font-weight: bold; }
        .quiz-options button { display: block; width: 100%; text-align: left; margin-bottom: 10px; background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
        .quiz-options button:hover:not(:disabled) { background-color: var(--bg-tertiary); }
        .quiz-tf-options { display: flex; gap: 10px; }
        .quiz-tf-options button { flex: 1; text-align: center; }
        .quiz-container button.correct { background-color: #d4edda; border-color: #c3e6cb; color: #155724; font-weight: bold; }
        .quiz-container button.incorrect { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        [data-theme="dark"] .quiz-container button.correct { background-color: #1a3c2a; border-color: #2a6a4a; color: #8ce99a; }
        [data-theme="dark"] .quiz-container button.incorrect { background-color: #4d1a21; border-color: #8b2a3a; color: #ffa8a8; }
        .quiz-feedback { margin-top: 15px; padding: 10px; border-radius: 6px; display: none; }
        .quiz-feedback.visible { display: block; }
        .quiz-feedback.correct { background-color: #d4edda; color: #155724; }
        .quiz-feedback.incorrect { background-color: #f8d7da; color: #721c24; }
        [data-theme="dark"] .quiz-feedback.correct { background-color: #1a3c2a; color: #8ce99a; }
        [data-theme="dark"] .quiz-feedback.incorrect { background-color: #4d1a21; color: #ffa8a8; }
        .quiz-fib-input { padding: 8px; border: 1px solid var(--border); border-radius: 4px; margin: 0 5px; background-color: var(--bg-secondary); color: var(--text-primary);}
        .check-fib-btn { width: auto; font-size: 15px; padding: 8px 16px; margin-left: 10px; }
        .retry-button { background-color: var(--text-secondary); font-size: 14px; padding: 10px 20px; margin-top: 10px; width: auto; color: var(--bg-secondary); }
        .retry-button:hover { opacity: 0.8; }
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5em 0; }
        .feedback-actions { margin-top: 12px; display: flex; gap: 10px; }
        .feedback-actions button { font-size: 14px; padding: 8px 12px; width: auto; color: #fff; }
        .reinforce-btn { background-color: #6f42c1; } .reinforce-btn:hover { background-color: #59369a; }
        .expand-btn { background-color: #17a2b8; } .expand-btn:hover { background-color: #138496; }
        #welcomeMessage { display: none; background-color: color-mix(in srgb, var(--primary) 15%, var(--bg-secondary)); border-left: 5px solid var(--primary); border-radius: 8px; padding: 20px; margin-bottom: 25px; line-height: 1.6; }
        #welcomeMessage p { margin: 0; }
        #welcomeMessage .small-spinner { margin: 0; display: inline-block; vertical-align: middle; margin-right: 10px;}
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: var(--bg-secondary); margin: 10% auto; padding: 25px; border: 1px solid var(--border); width: 90%; max-width: 700px; border-radius: 12px; position: relative; box-shadow: 0 5px 15px var(--shadow); }
        .modal-close { color: var(--text-secondary); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: var(--text-primary); }
        .modal-header { padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: var(--primary); }
        .modal-body { line-height: 1.7; color: var(--text-secondary); max-height: 60vh; overflow-y: auto; }
        .modal-body .prose { max-width: none; }
        /* UPGRADE: Styles for the new confirmation modal */
        .modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button { width: auto; }
        .confirm-btn-danger { background-color: var(--danger); }
        .confirm-btn-danger:hover { background-color: var(--danger-hover); }
        .cancel-btn { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .cancel-btn:hover { background-color: color-mix(in srgb, var(--text-secondary) 10%, var(--bg-tertiary)); }

        #scrollToTopBtn { display: none; position: fixed; bottom: 20px; right: 30px; z-index: 99; border: none; outline: none; background-color: var(--primary); color: white; cursor: pointer; padding: 0; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, visibility 0.3s; visibility: hidden; }
        #scrollToTopBtn.visible { display: flex; align-items: center; justify-content: center; visibility: visible; opacity: 1; }
        
        .sortable-list { list-style: none; padding: 10px; border-radius: 8px; background-color: color-mix(in srgb, var(--primary) 5%, transparent); min-height: 50px;}
        .sortable-item { padding: 12px; background-color: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: grab; user-select: none; transition: background-color 0.2s, box-shadow 0.2s; }
        .sortable-item:last-child { margin-bottom: 0; }
        .sortable-item.dragging { opacity: 0.5; background-color: color-mix(in srgb, var(--primary) 20%, transparent); }
        .matching-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        .matching-column { display: flex; flex-direction: column; gap: 8px; }
        .matching-column .static-item { padding: 12px; background-color: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; }
        .matching-column .sortable-item.correct { background-color: #d4edda; border-color: #c3e6cb; }
        .matching-column .sortable-item.incorrect { background-color: #f8d7da; border-color: #f5c6cb; }
        [data-theme="dark"] .matching-column .sortable-item.correct { background-color: #1a3c2a; border-color: #2a6a4a;}
        [data-theme="dark"] .matching-column .sortable-item.incorrect { background-color: #4d1a21; border-color: #8b2a3a;}

        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.1rem; margin-bottom: 20px; }
            #controls, #responseContainer { padding: 15px; }
            .learning-path li { padding: 12px 15px 12px 45px; }
            .learning-path li::before { width: 26px; height: 26px; left: 8px; }
            .lesson-block, .quiz-container { padding: 15px; }
            .modal-content { width: 95%; margin: 15% auto; }
            #scrollToTopBtn { bottom: 15px; right: 15px; width: 45px; height: 45px; }
            .matching-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <span style="font-size: 2.2rem; color: var(--primary);">🎓</span>
                <h1>LearnPath AI</h1>
            </div>
            <div class="header-actions">
                <button id="theme-toggle-btn" aria-label="Toggle dark mode">
                    <span class="sun-icon">☀️</span>
                    <span class="moon-icon" style="display: none;">🌙</span>
                </button>
            </div>
        </div>
        <h2>(v15.6: Sửa lỗi KaTeX triệt để)</h2>

        <div id="controls">
            <input type="text" id="topicInput" placeholder="Ví dụ: Định lý Pythagoras">
            
            <label for="pathLengthSelect" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 15px;">Độ chi tiết của lộ trình:</label>
            <select id="pathLengthSelect">
                <option value="3 đến 4 bước">Tóm tắt (3-4 bước)</option>
                <option value="5 đến 6 bước" selected>Tiêu chuẩn (5-6 bước)</option>
                <option value="7 đến 9 bước">Chi tiết (7-9 bước)</option>
            </select>
            
            <label for="learnerLevelSelect" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 15px;">Trình độ người học:</label>
            <select id="learnerLevelSelect">
                <option value="người mới bắt đầu">Người mới bắt đầu</option>
                <option value="người có kiến thức cơ bản" selected>Người có cơ bản</option>
                <option value="người muốn tìm hiểu nâng cao">Nâng cao</option>
            </select>

            <button id="generatePathButton">
                <span class="button-text">Tạo Lộ trình</span>
                <div class="spinner"></div>
            </button>
            <button id="clearProgressButton">Xóa tiến trình</button>
            <p id="statusMessage" class="status-message"></p>
        </div>
        
        <div id="welcomeMessage"></div>

        <h2>Lộ trình học đề xuất:</h2>
        <div id="responseContainer"></div>
    </div>
    
    <!-- AI Tutor Modal -->
    <div id="aiTutorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close">&times;</span>
                <h3 id="aiTutorModalTitle">Trợ lý AI</h3>
            </div>
            <div id="aiTutorModalBody" class="modal-body"></div>
        </div>
    </div>
    
    <!-- UPGRADE: New Confirmation Modal (replaces window.confirm) -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                 <span class="modal-close">&times;</span>
                <h3>Xác nhận hành động</h3>
            </div>
            <div id="confirmModalBody" class="modal-body">
                <p id="confirmModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button id="cancelBtn" class="cancel-btn">Hủy bỏ</button>
                <button id="confirmBtn" class="confirm-btn-danger">Xác nhận</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- IMPORTANT: Do not change the SDK and AI connection method as requested ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        
        const LS_KEY = 'learningPathState';
        const THEME_KEY = 'themePreference';

        const topicInput = document.getElementById('topicInput');
        const generatePathButton = document.getElementById('generatePathButton');
        const clearProgressButton = document.getElementById('clearProgressButton');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');

        // --- Theme Management ---
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const sunIcon = themeToggleBtn.querySelector('.sun-icon');
        const moonIcon = themeToggleBtn.querySelector('.moon-icon');
        
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            sunIcon.style.display = (theme === 'dark') ? 'none' : 'inline-block';
            moonIcon.style.display = (theme === 'dark') ? 'inline-block' : 'none';
        }
        
        themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, newTheme);
            applyTheme(newTheme);
        });
        
        // --- Modal Management ---
        const aiTutorModal = document.getElementById('aiTutorModal');
        const confirmationModal = document.getElementById('confirmationModal');
        
        function showTutorModal(title, content) {
            aiTutorModal.querySelector('#aiTutorModalTitle').textContent = title;
            const body = aiTutorModal.querySelector('#aiTutorModalBody');
            body.innerHTML = content;
            aiTutorModal.style.display = 'block';
            renderKatexInElement(body);
        }
        function hideTutorModal() { aiTutorModal.style.display = 'none'; }
        
        function showConfirmationModal(message, onConfirm) {
            confirmationModal.querySelector('#confirmModalMessage').textContent = message;
            confirmationModal.style.display = 'block';
            
            const confirmBtn = confirmationModal.querySelector('#confirmBtn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                onConfirm();
                hideConfirmationModal();
            };
        }
        function hideConfirmationModal() { confirmationModal.style.display = 'none'; }
        
        aiTutorModal.querySelector('.modal-close').onclick = hideTutorModal;
        confirmationModal.querySelector('.modal-close').onclick = hideConfirmationModal;
        confirmationModal.querySelector('#cancelBtn').onclick = hideConfirmationModal;

        window.onclick = (event) => {
            if (event.target === aiTutorModal) hideTutorModal();
            if (event.target === confirmationModal) hideConfirmationModal();
        };

        // --- Drag and Drop Utilities ---
        function addDragDropHandlers(list) {
            let draggingItem = null;
            list.querySelectorAll('.sortable-item').forEach(item => {
                item.setAttribute('draggable', 'true');
                item.addEventListener('dragstart', () => { draggingItem = item; setTimeout(() => item.classList.add('dragging'), 0); });
                item.addEventListener('dragend', () => { item.classList.remove('dragging'); draggingItem = null; });
            });

            list.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(list, e.clientY);
                if (draggingItem) {
                    if (afterElement == null) { list.appendChild(draggingItem); } 
                    else { list.insertBefore(draggingItem, afterElement); }
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.sortable-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- Main App Logic ---
        function saveState() {
            const topic = topicInput.value.trim();
            const pathHTML = responseContainer.innerHTML;
            if (topic && pathHTML && !responseContainer.querySelector('.empty-state')) {
                localStorage.setItem(LS_KEY, JSON.stringify({ topic, pathHTML }));
            }
        }
        
        const reviewTool = [{ functionDeclarations: [{ name: 'createReviewSheet', description: 'Tạo một bảng tóm tắt ôn tập các khái niệm chính.', parameters: { type: 'OBJECT', properties: { keyConcepts: { type: 'ARRAY', items: { type: 'OBJECT', properties: { concept: { type: 'STRING', description: 'Tên của khái niệm hoặc định nghĩa.' }, summary: { type: 'STRING', description: 'Một câu tóm tắt ngắn gọn, dễ hiểu về khái niệm đó.' } }, required: ['concept', 'summary'] } } }, required: ['keyConcepts'] } }] }];

        function displayReviewButton() {
            if(document.getElementById('reviewButton')) return;
            const reviewButton = document.createElement('button');
            reviewButton.id = 'reviewButton';
            reviewButton.textContent = '🎉 Chúc mừng! Xem tổng kết & ôn tập';
            reviewButton.style.marginTop = '20px';
            reviewButton.style.backgroundColor = 'var(--success)';
            reviewButton.onclick = generateReviewSheet;
            responseContainer.appendChild(reviewButton);
        }

        async function generateReviewSheet() {
            showTutorModal('Đang tạo bảng ôn tập...', '<div class="small-spinner"></div>');
            let learnedContent = `Chủ đề chính: ${topicInput.value}\n\n`;
            document.querySelectorAll('.lesson-detail').forEach((detail, index) => { learnedContent += `--- Nội dung bước ${index + 1} ---\n${detail.innerText}\n\n`; });
            const prompt = `Dựa trên toàn bộ nội dung đã học dưới đây, hãy xác định các khái niệm và định nghĩa quan trọng nhất, sau đó sử dụng công cụ 'createReviewSheet' để tạo một bảng tóm tắt ôn tập.\n\n**Nội dung đã học:**\n${learnedContent}`;

            try {
                const result = await model.generateContent({ contents: [{ role: 'user', parts: [{ text: prompt }] }], tools: reviewTool });
                const functionCalls = result.response.functionCalls();
                if (functionCalls && functionCalls.length > 0 && functionCalls[0].name === 'createReviewSheet') {
                    const reviewData = functionCalls[0].args;
                    // FIX: Apply marked.parseInline to correctly render markdown and KaTeX in the review sheet.
                    let reviewHtml = '<ul>' + reviewData.keyConcepts.map(item => {
                        const summaryHtml = marked.parseInline(item.summary || '');
                        return `<li><strong>${item.concept}:</strong> ${summaryHtml}</li>`;
                    }).join('') + '</ul>';
                    showTutorModal('Bảng ôn tập kiến thức', reviewHtml);
                } else {
                    const textResponse = result.response.text();
                    if (textResponse) { showTutorModal('Bảng ôn tập kiến thức', marked.parse(textResponse)); }
                    else { throw new Error("AI did not return a valid review sheet or text summary."); }
                }
            } catch (e) {
                console.error("Lỗi khi tạo bảng ôn tập:", e);
                // UPGRADE: Improved error reporting to show specific error message to the user.
                const errorMessage = `Không thể tạo bảng ôn tập. Vui lòng thử lại.<br><br><small style="color: var(--text-secondary);">Chi tiết lỗi: ${e.message}</small>`;
                showTutorModal('Lỗi', errorMessage);
            }
        }

        function markStepAsCompleted(quizElement) {
            const currentLi = quizElement.closest('li');
            if (!currentLi || currentLi.dataset.state === 'completed') return;
            currentLi.dataset.state = 'completed';
            const nextLi = currentLi.nextElementSibling;
            if (nextLi && nextLi.dataset.state === 'locked') { nextLi.dataset.state = 'unlocked'; } 
            else if (!nextLi) { displayReviewButton(); }
            saveState(); 
        }
        
        function renderKatexInElement(element) {
            if (window.renderMathInElement) {
                renderMathInElement(element, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true} ], throwOnError: false });
            }
        }
        
        const toolImplementations = {
            createMultipleChoiceQuiz(args, container) {
                const { question, options, correctAnswerIndex, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createMultipleChoiceQuiz';
                container.dataset.quizArgs = JSON.stringify(args);
                container.innerHTML = `<p>${question}</p><div class="quiz-options">${options.map((o, i) => `<button data-index="${i}">${o}</button>`).join('')}</div><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.quiz-options').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn || btn.parentElement.querySelector(':disabled')) return;
                    const selected = parseInt(btn.dataset.index);
                    const isCorrect = selected === correctAnswerIndex;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    feedbackEl.innerHTML = `<p>${explanation}</p><div class="feedback-actions">${isCorrect ? '<button class="expand-btn">Mở rộng kiến thức ✨</button>' : '<button class="reinforce-btn">Củng cố kiến thức 🤔</button>'}</div>`;
                    if (isCorrect) { feedbackEl.querySelector('.expand-btn').onclick = () => requestExpansion(args); } 
                    else { feedbackEl.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, options[selected]); }
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    renderKatexInElement(feedbackEl);
                    container.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        if (parseInt(b.dataset.index) === correctAnswerIndex) b.classList.add('correct');
                        else if (parseInt(b.dataset.index) === selected) b.classList.add('incorrect');
                    });
                    markStepAsCompleted(container);
                });
            },
            createFillInTheBlankQuiz(args, container) {
                const { sentence, correctAnswer, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createFillInTheBlankQuiz';
                container.dataset.quizArgs = JSON.stringify(args);
                container.innerHTML = `<p>${sentence.replace("___", `<input type="text" class="quiz-fib-input" placeholder="...">`)}</p><button class="check-fib-btn">Kiểm tra</button><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.check-fib-btn').addEventListener('click', () => {
                    const input = container.querySelector('input');
                    const userAnswer = input.value.trim();
                    const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    input.disabled = true;
                    container.querySelector('.check-fib-btn').disabled = true;
                    feedbackEl.innerHTML = `<p><strong>Giải thích:</strong> ${explanation}</p><div class="feedback-actions">${isCorrect ? '<button class="expand-btn">Mở rộng kiến thức ✨</button>' : '<button class="reinforce-btn">Củng cố kiến thức 🤔</button>'}</div>`;
                    if (isCorrect) { feedbackEl.querySelector('.expand-btn').onclick = () => requestExpansion(args); }
                    else { feedbackEl.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, userAnswer); }
                    renderKatexInElement(feedbackEl);
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    input.classList.add(isCorrect ? 'correct' : 'incorrect');
                    if (!isCorrect) input.value += ` (Đúng: ${correctAnswer})`;
                    markStepAsCompleted(container);
                });
            },
            createTrueFalseQuiz(args, container) {
                const { statement, isCorrect, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createTrueFalseQuiz';
                container.dataset.quizArgs = JSON.stringify(args);
                container.innerHTML = `<p>${statement}</p><div class="quiz-tf-options"><button data-answer="true">Đúng</button><button data-answer="false">Sai</button></div><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.quiz-tf-options').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn || btn.parentElement.querySelector(':disabled')) return;
                    const answer = btn.dataset.answer === 'true';
                    const isCorrectAnswer = answer === isCorrect;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    feedbackEl.innerHTML = `<p>${explanation}</p><div class="feedback-actions">${isCorrectAnswer ? '<button class="expand-btn">Mở rộng kiến thức ✨</button>' : '<button class="reinforce-btn">Củng cố kiến thức 🤔</button>'}</div>`;
                    if (isCorrectAnswer) { feedbackEl.querySelector('.expand-btn').onclick = () => requestExpansion(args); } 
                    else { feedbackEl.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, answer ? 'Đúng' : 'Sai'); }
                    renderKatexInElement(feedbackEl);
                    feedbackEl.className = `quiz-feedback visible ${isCorrectAnswer ? 'correct' : 'incorrect'}`;
                    container.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        if ((b.dataset.answer === 'true') === isCorrect) b.classList.add('correct');
                    });
                    if (!isCorrectAnswer) btn.classList.add('incorrect');
                    markStepAsCompleted(container);
                });
            },
            createSortingQuiz(args, container) {
                const { title, items, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createSortingQuiz';
                container.dataset.quizArgs = JSON.stringify(args);
                const shuffledItems = [...items].sort(() => Math.random() - 0.5);
                container.innerHTML = `<p>${title}</p><div class="sortable-list">${shuffledItems.map(item => `<div class="sortable-item">${item}</div>`).join('')}</div><button class="check-fib-btn" style="margin-top: 15px;">Kiểm tra</button><div class="quiz-feedback"></div>`;
                const list = container.querySelector('.sortable-list');
                addDragDropHandlers(list);
                container.querySelector('.check-fib-btn').addEventListener('click', e => {
                    e.target.disabled = true;
                    const userOrder = [...list.querySelectorAll('.sortable-item')].map(el => el.textContent);
                    const isCorrect = JSON.stringify(userOrder) === JSON.stringify(items);
                    list.querySelectorAll('.sortable-item').forEach(itemEl => itemEl.setAttribute('draggable', 'false'));
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    feedbackEl.innerHTML = `<p>${explanation}</p><p><strong>Thứ tự đúng:</strong><br>${items.join(' → ')}</p><div class="feedback-actions">${isCorrect ? '<button class="expand-btn">Mở rộng kiến thức ✨</button>' : '<button class="reinforce-btn">Củng cố kiến thức 🤔</button>'}</div>`;
                    if (isCorrect) { feedbackEl.querySelector('.expand-btn').onclick = () => requestExpansion(args); }
                    else { feedbackEl.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, "Thứ tự chưa đúng"); }
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    markStepAsCompleted(container);
                });
            },
            createMatchingQuiz(args, container) {
                const { title, columnA, columnB, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createMatchingQuiz';
                container.dataset.quizArgs = JSON.stringify(args);
                const shuffledB = [...columnB].sort(() => Math.random() - 0.5);
                container.innerHTML = `<p>${title}</p><div class="matching-grid"><div class="matching-column">${columnA.map(item => `<div class="static-item">${item}</div>`).join('')}</div><div class="matching-column sortable-list">${shuffledB.map(item => `<div class="sortable-item">${item}</div>`).join('')}</div></div><button class="check-fib-btn" style="margin-top: 15px;">Kiểm tra</button><div class="quiz-feedback"></div>`;
                const list = container.querySelector('.sortable-list');
                addDragDropHandlers(list);
                container.querySelector('.check-fib-btn').addEventListener('click', e => {
                    e.target.disabled = true;
                    let correctCount = 0;
                    list.querySelectorAll('.sortable-item').forEach((itemEl, index) => {
                        itemEl.setAttribute('draggable', 'false');
                        if (itemEl.textContent === columnB[index]) { correctCount++; itemEl.classList.add('correct'); } 
                        else { itemEl.classList.add('incorrect'); }
                    });
                    const isAllCorrect = correctCount === columnA.length;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    feedbackEl.innerHTML = `<p>${explanation}</p><p>Bạn đã nối đúng ${correctCount}/${columnA.length} cặp.</p><div class="feedback-actions">${isAllCorrect ? '<button class="expand-btn">Mở rộng kiến thức ✨</button>' : '<button class="reinforce-btn">Củng cố kiến thức 🤔</button>'}</div>`;
                    if (isAllCorrect) { feedbackEl.querySelector('.expand-btn').onclick = () => requestExpansion(args); }
                    else { feedbackEl.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, "Các cặp nối chưa đúng"); }
                    feedbackEl.className = `quiz-feedback visible ${isAllCorrect ? 'correct' : 'incorrect'}`;
                    markStepAsCompleted(container);
                });
            }
        };

        const firebaseConfig = { apiKey: "AIzaSyC3fY7kRz2P9BBIBd_jr7b3z5ZUpG5JH8g", authDomain: "cboxauto-minh.firebaseapp.com", projectId: "cboxauto-minh", storageBucket: "cboxauto-minh.appspot.com", messagingSenderId: "476350924183", appId: "1:476350924183:web:d40a9da3c8902e1d7230d2" };
        const app = initializeApp(firebaseConfig);

        function updateStatus(type, message) { statusMessage.className = `status-message ${type}`; statusMessage.innerHTML = message; }
        function toggleButtonLoading(isLoading) { const btnTxt = generatePathButton.querySelector('.button-text'); generatePathButton.disabled = isLoading; generatePathButton.classList.toggle('loading', isLoading); btnTxt.textContent = isLoading ? 'Đang tạo...' : 'Tạo Lộ trình'; }
        
        function parseAiJson(text) {
            const match = text.match(/```(json)?\s*([\s\S]*?)\s*```/);
            let jsonString = match ? match[2].trim() : text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
            try { return JSON.parse(jsonString); } catch (e) {
                console.warn("Lỗi JSON parse lần 1, thử sửa lỗi...", e);
                const repairedString = jsonString.replace(/,\s*([}\]])/g, '$1');
                try { return JSON.parse(repairedString); } catch (finalError) { console.error("Không thể sửa và parse JSON:", finalError); throw new Error("Dữ liệu JSON từ AI không hợp lệ."); }
            }
        }
        
        const quizTools = [{ functionDeclarations: [ { name: 'createMultipleChoiceQuiz', description: 'Tạo một câu hỏi trắc nghiệm.', parameters: { type: 'OBJECT', properties: { question: { type: 'STRING' }, options: { type: 'ARRAY', items: { type: 'STRING' } }, correctAnswerIndex: { type: 'NUMBER' }, explanation: { type: 'STRING' } }, required: ['question', 'options', 'correctAnswerIndex', 'explanation'] } }, { name: 'createFillInTheBlankQuiz', description: 'Tạo một câu hỏi điền vào chỗ trống.', parameters: { type: 'OBJECT', properties: { sentence: { type: 'STRING', description: 'Câu chứa ___ cho chỗ trống.' }, correctAnswer: { type: 'STRING' }, explanation: { type: 'STRING' } }, required: ['sentence', 'correctAnswer', 'explanation'] } }, { name: 'createTrueFalseQuiz', description: 'Tạo một câu hỏi Đúng/Sai.', parameters: { type: 'OBJECT', properties: { statement: { type: 'STRING' }, isCorrect: { type: 'BOOLEAN' }, explanation: { type: 'STRING' } }, required: ['statement', 'isCorrect', 'explanation'] } }, { name: 'createSortingQuiz', description: 'Tạo bài tập sắp xếp các mục.', parameters: { type: 'OBJECT', properties: { title: { type: 'STRING' }, items: { type: 'ARRAY', items: { type: 'STRING' }, description: 'Mảng các mục đã ở đúng thứ tự.' }, explanation: { type: 'STRING' } }, required: ['title', 'items', 'explanation'] } }, { name: 'createMatchingQuiz', description: 'Tạo bài tập nối cột.', parameters: { type: 'OBJECT', properties: { title: { type: 'STRING' }, columnA: { type: 'ARRAY', items: { type: 'STRING' } }, columnB: { type: 'ARRAY', items: { type: 'STRING' }, description: 'Cột B, theo đúng thứ tự tương ứng với cột A.' }, explanation: { type: 'STRING' } }, required: ['title', 'columnA', 'columnB', 'explanation'] } } ] }];
        const learningPathTool = [{ functionDeclarations: [{ name: 'createLearningPath', description: 'Tạo một lộ trình học có cấu trúc.', parameters: { type: 'OBJECT', properties: { steps: { type: 'ARRAY', items: { type: 'STRING' }, description: 'Một mảng các chuỗi, mỗi chuỗi là tiêu đề của một bước học.' } }, required: ['steps'] } }] }];
        
        let model;
        try { model = getGenerativeModel(getAI(app), { model: "gemini-2.5-flash" }); updateStatus('success-text', "Mô hình AI đã sẵn sàng!"); } 
        catch (e) { console.error("Lỗi khởi tạo AI Model:", e); updateStatus('error-text', `Lỗi khởi tạo AI Model: ${e.message}.`); }
        
        async function getLessonDetail(topic, detailElement) {
            if (!model) { detailElement.innerHTML = `<p class="error">Mô hình AI chưa sẵn sàng.</p>`; return; }
            detailElement.innerHTML = '<div class="small-spinner"></div>';
            
            try {
                const lessonPrompt = `Bạn là một gia sư AI. Hãy tạo nội dung bài học về: "${topic}". QUY TẮC: Mọi công thức toán học PHẢI dùng cú pháp KaTeX (ví dụ: $\\pi$ phải là "$\\\\pi$"). CHỈ trả lời bằng một khối mã JSON hợp lệ duy nhất theo cấu trúc sau: \`\`\`json\n{"lessonTitle": "...", "introduction": "...", "contentBlocks": [{"type": "explanation", "title": "...", "content": "..."}, {"type": "example", "title": "...", "content": "..."}]}\n\`\`\``;
                const lessonResult = await model.generateContent(lessonPrompt);
                const lessonData = parseAiJson(lessonResult.response.text());
                if (!lessonData) throw new Error("Dữ liệu bài học từ AI không hợp lệ.");
                renderStructuredLesson(lessonData, detailElement);

                // FIX: Added a strict rule for the AI to double-escape backslashes in quiz generation to prevent rendering errors.
                const quizPrompt = `Dựa vào chủ đề bài học "${topic}", hãy tạo 2-3 câu hỏi ôn tập **đa dạng** bằng các công cụ được cung cấp. **QUY TẮC BẮT BUỘC:** Mọi công thức hoặc ký hiệu toán học trong các tham số của công cụ (như question, explanation, title, items) đều PHẢI dùng cú pháp KaTeX, được bao bọc trong dấu đô la, và mọi dấu '\\' phải được escape thành '\\\\'. Ví dụ: "Giá trị của $\\\\pi$ là bao nhiêu?" hoặc một lựa chọn là "$\\\\frac{1}{2}"$.`;
                const quizResult = await model.generateContent({ contents: [{ role: 'user', parts: [{ text: quizPrompt }] }], tools: quizTools });
                const functionCalls = quizResult.response.functionCalls();
                if (functionCalls && functionCalls.length > 0) { renderSummaryQuiz(functionCalls, detailElement); }
                saveState();
            } catch (error) {
                console.error("Lỗi khi lấy chi tiết bài học:", error);
                detailElement.innerHTML = `<p class="status-message error-text">Không thể tải nội dung. Vui lòng thử lại.</p><button class="retry-button">Thử lại</button>`;
                detailElement.querySelector('.retry-button').addEventListener('click', () => getLessonDetail(topic, detailElement));
            }
        }

        function renderStructuredLesson(data, parentElement) {
            parentElement.innerHTML = ''; 
            const createBlock = (type, title, content) => `<div class="lesson-block ${type}"><div class="lesson-block-title">${getIconForBlockType(type)}<span>${title}</span></div><div class="lesson-content">${marked.parse(content)}</div></div>`;
            if (data.introduction) parentElement.innerHTML += createBlock('explanation', data.lessonTitle || 'Giới thiệu', data.introduction);
            if (data.contentBlocks) data.contentBlocks.forEach(block => parentElement.innerHTML += createBlock(block.type || 'explanation', block.title, block.content));
            renderKatexInElement(parentElement);
        }
        
        function getIconForBlockType(type) { return ({ example: '💡', note: '📌', explanation: '🧠' })[type] || '🧠'; }

        function renderSummaryQuiz(functionCalls, parentElement) {
            const block = document.createElement('div');
            block.className = 'practice-set';
            block.innerHTML = `<div class="summary-quiz-title">📝 <span>Bài tập tổng kết</span></div>`;
            functionCalls.forEach(call => {
                const exerciseContainer = document.createElement('div');
                exerciseContainer.className = 'quiz-container';
                block.appendChild(exerciseContainer);
                if (toolImplementations[call.name]) { toolImplementations[call.name](call.args, exerciseContainer); }
                else { exerciseContainer.textContent = `Lỗi: Không thể hiển thị bài tập loại "${call.name}".`; }
            });
            parentElement.appendChild(block);
        }

        async function generateLearningPath() {
             if (!model) { updateStatus('error-text', "Mô hình AI chưa được khởi tạo."); return; }
             const topic = topicInput.value.trim();
             if (!topic) { updateStatus('error-text', "Vui lòng nhập một chủ đề!"); return; }
             const pathLength = document.getElementById('pathLengthSelect').value;
             const learnerLevel = document.getElementById('learnerLevelSelect').value;
             updateStatus('info-text', `Đang tạo lộ trình thông minh...`);
             responseContainer.innerHTML = '<div class="large-spinner"></div>';
             toggleButtonLoading(true);

             const prompt = `Phân tích chủ đề "${topic}" cho "${learnerLevel}", sau đó gọi công cụ \`createLearningPath\` để tạo một lộ trình học gồm ${pathLength} với các tiêu đề bước học rõ ràng, logic.`;
             
             try {
                const result = await model.generateContent({ contents: [{ role: 'user', parts: [{ text: prompt }] }], tools: learningPathTool });
                const functionCalls = result.response.functionCalls();
                if (!functionCalls || functionCalls[0]?.name !== 'createLearningPath') throw new Error("AI did not return a valid learning path structure.");
                const pathItems = functionCalls[0].args.steps;
                if (!Array.isArray(pathItems) || pathItems.length === 0) throw new Error("Invalid path data from function call");

                responseContainer.innerHTML = `<div class="learning-path"><ol>${pathItems.map((item, index) => `<li data-topic="${item.replace(/"/g, '&quot;')}" data-state="${index === 0 ? 'unlocked' : 'locked'}"><span class="lesson-title">${item}</span><div class="lesson-detail"></div></li>`).join('')}</ol></div>`;
                updateStatus('success-text', "Đã tạo lộ trình! Nhấp vào mục đầu tiên để bắt đầu.");
                saveState();
             } catch (error) {
                console.error("Lỗi khi tạo lộ trình:", error);
                renderEmptyState(`<p class="status-message error-text">Không thể tạo lộ trình. Vui lòng thử lại.</p>`);
                updateStatus('error-text', `Lỗi: ${error.message}`);
             } finally {
                toggleButtonLoading(false);
             }
        }
        
        async function requestTutorHelp(modalTitle, prompt) {
            showTutorModal(modalTitle, '<div class="small-spinner"></div>');
            try {
                const result = await model.generateContent(prompt);
                showTutorModal(modalTitle, marked.parse(result.response.text()));
            } catch(e) { showTutorModal("Lỗi", "Không thể kết nối với AI để tạo bài học."); }
        }

        function requestReinforcement(questionArgs, userAnswer) {
            const questionText = questionArgs.question || questionArgs.statement || questionArgs.title;
            const correctAnswer = questionArgs.correctAnswer || (questionArgs.options ? questionArgs.options[questionArgs.correctAnswerIndex] : 'N/A');
            const prompt = `Một học sinh vừa trả lời SAI câu hỏi. Hãy cung cấp một bài học ngắn gọn (tiếng Việt, Markdown) để củng cố kiến thức. Mọi công thức toán học phải dùng KaTeX. Câu hỏi: "${questionText}". Câu trả lời sai: "${userAnswer}". Đáp án đúng: "${correctAnswer}". Bài học cần: Phân tích lỗi sai, giảng lại khái niệm, và ví dụ minh họa.`;
            requestTutorHelp("Củng cố kiến thức", prompt);
        }

        function requestExpansion(questionArgs) {
            const questionText = questionArgs.question || questionArgs.statement || questionArgs.title;
            const prompt = `Một học sinh vừa trả lời ĐÚNG câu hỏi: "${questionText}". Hãy khen ngợi và cung cấp một kiến thức mở rộng ngắn gọn (tiếng Việt, Markdown) liên quan. Mọi công thức toán học phải dùng KaTeX.`;
            requestTutorHelp("Mở rộng kiến thức", prompt);
        }

        responseContainer.addEventListener('click', async (event) => {
            const li = event.target.closest('li');
            if (!li || event.target.closest('.quiz-container, .feedback-actions, .retry-button')) return;
            if (li.dataset.state === 'locked') { li.style.animation = 'shake 0.5s'; setTimeout(() => li.style.animation = '', 500); return; }
            
            const wasActive = li.classList.contains('active');
            responseContainer.querySelectorAll('li').forEach(item => item.classList.remove('active'));
            if (!wasActive) {
                li.classList.add('active');
                li.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const detailEl = li.querySelector('.lesson-detail');
                if (detailEl && detailEl.innerHTML === '') await getLessonDetail(li.dataset.topic, detailEl);
            }
            saveState();
        });

        generatePathButton.addEventListener("click", generateLearningPath);

        async function generateWelcomeBackMessage(mainTopic, lastLessonTopic) {
            if (!model || !lastLessonTopic) return;
            const welcomeContainer = document.getElementById('welcomeMessage');
            welcomeContainer.style.display = 'block';
            welcomeContainer.innerHTML = `<div class="small-spinner"></div> <p>AI đang viết lời chào mừng...</p>`;
            const prompt = `Tạo một lời chào mừng ngắn gọn (2-3 câu), thân thiện để chào người dùng quay lại. Chủ đề họ đang học là: "${mainTopic}". Bài học gần nhất họ xem là: "${lastLessonTopic}". Gợi ý cho họ tiếp tục học từ bài đó. Trả lời bằng văn bản thuần túy.`;
            try {
                const result = await model.generateContent(prompt);
                welcomeContainer.innerHTML = `<p><strong>Trợ lý AI:</strong> ${result.response.text().replace(/\n/g, '<br>')}</p>`;
            } catch (error) {
                console.error("Lỗi tạo lời chào:", error);
                welcomeContainer.innerHTML = `<p>Chào mừng bạn đã quay trở lại! Hãy cùng tiếp tục học về <strong>${mainTopic}</strong> nhé.</p>`;
            }
        }
        
        function rehydrateQuizzes() {
            responseContainer.querySelectorAll('.quiz-container').forEach(container => {
                const { quizType, quizArgs } = container.dataset;
                const isAnswered = container.querySelector('button:disabled');
                if (quizType && quizArgs && toolImplementations[quizType] && !isAnswered) {
                    try { toolImplementations[quizType](JSON.parse(quizArgs), container); } 
                    catch (e) { console.error("Lỗi khi rehydrate quiz:", e, container); }
                }
            });
        }
        
        function renderEmptyState(customHTML = '') {
             responseContainer.innerHTML = customHTML || `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
                    <h3>Bắt đầu hành trình kiến thức của bạn</h3>
                    <p>Nhập một chủ đề bạn muốn học và để AI tạo ra một lộ trình dành riêng cho bạn.</p>
                </div>`;
        }

        function loadState() {
            const savedStateJSON = localStorage.getItem(LS_KEY);
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    topicInput.value = savedState.topic;
                    responseContainer.innerHTML = savedState.pathHTML;
                    responseContainer.querySelectorAll('.lesson-content, .quiz-container, .quiz-feedback').forEach(renderKatexInElement);
                    rehydrateQuizzes();
                    const lastActiveLI = responseContainer.querySelector('li.active');
                    generateWelcomeBackMessage(savedState.topic, lastActiveLI?.dataset.topic);
                    updateStatus('success-text', 'Đã tải lại lộ trình học của bạn!');
                } catch(e) {
                    console.error("Lỗi khi tải tiến trình:", e);
                    localStorage.removeItem(LS_KEY); 
                    renderEmptyState();
                }
            } else {
                renderEmptyState();
            }
        }
        
        clearProgressButton.addEventListener('click', () => {
             // UPGRADE: Replaced window.confirm with a non-blocking custom modal
            showConfirmationModal('Bạn có chắc muốn xóa tất cả tiến trình đã lưu không?', () => {
                localStorage.removeItem(LS_KEY);
                topicInput.value = '';
                renderEmptyState();
                document.getElementById('welcomeMessage').style.display = 'none';
                updateStatus('info-text', 'Đã xóa tiến trình. Bạn có thể bắt đầu lại.');
            });
        });

        const scrollToTopBtn = document.createElement('button');
        scrollToTopBtn.id = 'scrollToTopBtn';
        scrollToTopBtn.title = 'Lên đầu trang';
        scrollToTopBtn.innerHTML = '&#8593;';
        document.body.appendChild(scrollToTopBtn);
        window.addEventListener('scroll', () => { scrollToTopBtn.classList.toggle('visible', window.scrollY > 300); });
        scrollToTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });

        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(localStorage.getItem(THEME_KEY) || 'light');
            loadState();
        });
    </script>
</body>
</html>

