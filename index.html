<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnPath AI - (v13.4: Tùy chỉnh Trình độ)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMQNogNJeASiX9UrxmoL2ACafVVfk5TBccNsB6SbAtUWWl0ES" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; color: #212529; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 850px; }
        h1, h2 { color: #0056b3; text-align: center; margin-bottom: 5px; }
        h1 { font-size: 2.2rem; }
        h2 { font-size: 1.2rem; font-weight: 400; margin-bottom: 30px;}
        #controls { margin-bottom: 30px; background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #dee2e6; }
        input[type="text"], select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ced4da; border-radius: 8px; box-sizing: border-box; font-size: 16px; background-color: #fff; }
        input[type="text"]:focus, select:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        button { width: 100%; padding: 14px 25px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 17px; transition: background-color 0.3s ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; }
        button:hover { background-color: #0056b3; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #a0c3e6; cursor: not-allowed; opacity: 0.9; }
        #clearProgressButton { background-color: #6c757d; margin-top: 10px; }
        #clearProgressButton:hover { background-color: #5a6268; }
        #responseContainer { background-color: #fff; border-radius: 12px; min-height: 100px; width: 100%; padding: 15px; box-sizing: border-box; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #dee2e6; }
        .learning-path ol { list-style-type: none; padding-left: 0; margin: 0; counter-reset: lesson-counter; }
        .learning-path li { background-color: #f8f9fa; margin-bottom: 10px; padding: 15px 20px 15px 50px; border-radius: 8px; border-left: 5px solid #6c757d; counter-increment: lesson-counter; position: relative; transition: all 0.3s ease; }
        .learning-path li[data-state="locked"] { background-color: #e9ecef; border-left-color: #adb5bd; cursor: not-allowed; opacity: 0.7; }
        .learning-path li[data-state="unlocked"] { border-left-color: #007bff; cursor: pointer; }
        .learning-path li[data-state="unlocked"]:hover { background-color: #e2e6ea; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .learning-path li[data-state="completed"] { border-left-color: #28a745; background-color: #e6f7ec; cursor: pointer; }
        .learning-path li::before { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background-color: #6c757d; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: monospace; font-size: 1.2rem; content: "🔒"; }
        .learning-path li[data-state="unlocked"]::before { background-color: #007bff; content: counter(lesson-counter); }
        .learning-path li[data-state="completed"]::before { background-color: #28a745; content: "✓"; }
        .lesson-title { font-weight: 500; font-size: 1.05rem;}
        .learning-path li.active { border-left-color: #fd7e14; }
        .learning-path li.active::before { background-color: #fd7e14; }
        .learning-path li[data-state="completed"].active { border-left-color: #198754; }
        .learning-path li[data-state="completed"].active::before { background-color: #198754; }
        .lesson-detail { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; }
        .learning-path li.active .lesson-detail { display: block; }
        .lesson-block { background-color: #fff; border: 1px solid #e9ecef; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .lesson-block-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .lesson-block.explanation { border-left: 4px solid #17a2b8; }
        .lesson-block.explanation .lesson-block-title { color: #17a2b8; }
        .lesson-block.example { border-left: 4px solid #ffc107; background-color: #fffbeb; }
        .lesson-block.example .lesson-block-title { color: #d39e00; }
        .lesson-block.note { border-left: 4px solid #6f42c1; background-color: #f4f0ff; }
        .lesson-block.note .lesson-block-title { color: #6f42c1; }
        .summary-quiz-title { font-size: 1.3rem; font-weight: 600; color: #d63384; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .practice-set .quiz-container { margin-bottom: 15px; }
        .practice-set .quiz-container:last-child { margin-bottom: 0; }
        .lesson-content { white-space: normal; word-wrap: break-word; line-height: 1.7; }
        .lesson-content p { margin-top: 0; margin-bottom: 1rem; }
        .lesson-content ul, .lesson-content ol { padding-left: 20px; }
        .lesson-content li { margin-bottom: 0.5rem; }
        .lesson-content strong { color: #0056b3; }
        .lesson-content code { background-color: #e9ecef; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        .status-message { margin-top: 15px; font-weight: bold; font-size: 0.95rem; text-align: center; width: 100%; }
        .status-message.error-text { color: #dc3545; }
        .status-message.success-text { color: #28a745; }
        .status-message.info-text { color: #17a2b8; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        button.loading .spinner { display: block; }
        .large-spinner, .small-spinner { border-radius: 50%; animation: spin 1.2s linear infinite; margin: auto; }
        .large-spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #007bff;}
        .small-spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff;}
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .quiz-container { background-color: #f0f7ff; border: 1px solid #b3d7ff; border-radius: 8px; padding: 20px; }
        .quiz-container p { margin-top: 0; font-weight: bold; }
        .quiz-options button { display: block; width: 100%; text-align: left; margin-bottom: 10px; background-color: #fff; color: #333; border: 1px solid #ced4da; }
        .quiz-options button:hover:not(:disabled) { background-color: #e9ecef; }
        .quiz-tf-options { display: flex; gap: 10px; }
        .quiz-tf-options button { flex: 1; text-align: center; }
        .quiz-container button.correct { background-color: #d4edda; border-color: #c3e6cb; color: #155724; font-weight: bold; }
        .quiz-container button.incorrect { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .quiz-feedback { margin-top: 15px; padding: 10px; border-radius: 6px; display: none; }
        .quiz-feedback.visible { display: block; }
        .quiz-feedback.correct { background-color: #d4edda; color: #155724; }
        .quiz-feedback.incorrect { background-color: #f8d7da; color: #721c24; }
        .quiz-fib-input { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin: 0 5px; }
        .check-fib-btn { width: auto; font-size: 15px; padding: 8px 16px; margin-left: 10px; }
        .retry-button { background-color: #6c757d; font-size: 14px; padding: 10px 20px; margin-top: 10px; width: auto; }
        .retry-button:hover { background-color: #5a6268; }
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5em 0; }
        .feedback-actions { margin-top: 12px; display: flex; gap: 10px; }
        .feedback-actions button { font-size: 14px; padding: 8px 12px; width: auto; }
        .reinforce-btn { background-color: #6f42c1; } .reinforce-btn:hover { background-color: #59369a; }
        .expand-btn { background-color: #17a2b8; } .expand-btn:hover { background-color: #138496; }
        #welcomeMessage { display: none; background-color: #e7f3ff; border-left: 5px solid #007bff; border-radius: 8px; padding: 20px; margin-bottom: 25px; line-height: 1.6; }
        #welcomeMessage p { margin: 0; }
        #welcomeMessage .small-spinner { margin: 0; display: inline-block; vertical-align: middle; margin-right: 10px;}
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 12px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: black; }
        .modal-header { padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: #0056b3; }
        .modal-body { line-height: 1.7; }
        .modal-body .prose { max-width: none; }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.1rem; margin-bottom: 20px; }
            #controls, #responseContainer { padding: 15px; }
            .learning-path li { padding: 12px 15px 12px 45px; }
            .learning-path li::before { width: 26px; height: 26px; left: 8px; }
            .lesson-block, .quiz-container { padding: 15px; }
            .modal-content { width: 95%; margin: 5% auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LearnPath AI 🚀</h1>
        <h2>(v13.4: Tùy chỉnh Trình độ)</h2>

        <div id="controls">
            <input type="text" id="topicInput" placeholder="Ví dụ: Định lý Pythagoras">
            
            <label for="pathLengthSelect" style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057; font-size: 15px;">Độ chi tiết của lộ trình:</label>
            <select id="pathLengthSelect">
                <option value="3 đến 4 bước">Tóm tắt (3-4 bước)</option>
                <option value="5 đến 6 bước" selected>Tiêu chuẩn (5-6 bước)</option>
                <option value="7 đến 9 bước">Chi tiết (7-9 bước)</option>
            </select>
            
            <!-- NEW: Learner level selector -->
            <label for="learnerLevelSelect" style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057; font-size: 15px;">Trình độ người học:</label>
            <select id="learnerLevelSelect">
                <option value="người mới bắt đầu">Người mới bắt đầu</option>
                <option value="người có kiến thức cơ bản" selected>Người có cơ bản</option>
                <option value="người muốn tìm hiểu nâng cao">Nâng cao</option>
            </select>

            <button id="generatePathButton">
                <span class="button-text">Tạo Lộ trình</span>
                <div class="spinner"></div>
            </button>
            <button id="clearProgressButton">Xóa tiến trình</button>
            <p id="statusMessage" class="status-message"></p>
        </div>
        
        <div id="welcomeMessage"></div>

        <h2>Lộ trình học đề xuất:</h2>
        <div id="responseContainer">Chưa có lộ trình nào được tạo...</div>
    </div>
    
    <div id="aiTutorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close">&times;</span>
                <h3 id="aiTutorModalTitle">Trợ lý AI</h3>
            </div>
            <div id="aiTutorModalBody" class="modal-body">
                <p>Nội dung sẽ được tải ở đây...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        
        const LS_KEY = 'learningPathState';

        function saveState() {
            const topic = topicInput.value.trim();
            const pathHTML = responseContainer.innerHTML;
            if (topic && pathHTML && pathHTML !== 'Chưa có lộ trình nào được tạo...') {
                const state = { topic, pathHTML };
                localStorage.setItem(LS_KEY, JSON.stringify(state));
                console.log("Tiến trình đã được lưu!");
            }
        }

        function markStepAsCompleted(quizElement) {
            const currentLi = quizElement.closest('li');
            if (!currentLi || currentLi.dataset.state === 'completed') return;
            currentLi.dataset.state = 'completed';
            const nextLi = currentLi.nextElementSibling;
            if (nextLi && nextLi.dataset.state === 'locked') {
                nextLi.dataset.state = 'unlocked';
            }
            saveState(); 
        }
        
        function renderKatexInElement(element) {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true} ],
                    throwOnError: false
                });
            }
        }
        
        const aiTutorModal = document.getElementById('aiTutorModal');
        const aiTutorModalTitle = document.getElementById('aiTutorModalTitle');
        const aiTutorModalBody = document.getElementById('aiTutorModalBody');
        const modalCloseBtn = aiTutorModal.querySelector('.modal-close');

        function showTutorModal(title, content) {
            aiTutorModalTitle.textContent = title;
            aiTutorModalBody.innerHTML = content;
            aiTutorModal.style.display = 'block';
            renderKatexInElement(aiTutorModalBody);
        }
        
        function hideTutorModal() {
            aiTutorModal.style.display = 'none';
        }
        modalCloseBtn.onclick = hideTutorModal;
        window.onclick = (event) => {
            if (event.target == aiTutorModal) {
                hideTutorModal();
            }
        }

        const toolImplementations = {
            createMultipleChoiceQuiz(args, container) {
                const { question, options, correctAnswerIndex, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createMultipleChoiceQuiz';
                container.dataset.quizArgs = JSON.stringify(args);
                
                container.innerHTML = `<p>${question}</p><div class="quiz-options">${options.map((o, i) => `<button data-index="${i}">${o}</button>`).join('')}</div><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.quiz-options').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn || btn.parentElement.querySelector(':disabled')) return;
                    
                    const selected = parseInt(btn.dataset.index);
                    const isCorrect = selected === correctAnswerIndex;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    
                    let feedbackHTML = `<p>${explanation}</p><div class="feedback-actions"></div>`;
                    feedbackEl.innerHTML = feedbackHTML;

                    const actionsContainer = feedbackEl.querySelector('.feedback-actions');
                    if (isCorrect) {
                        actionsContainer.innerHTML = `<button class="expand-btn">Mở rộng kiến thức ✨</button>`;
                        actionsContainer.querySelector('.expand-btn').onclick = () => requestExpansion(args);
                    } else {
                        actionsContainer.innerHTML = `<button class="reinforce-btn">Củng cố kiến thức 🤔</button>`;
                        actionsContainer.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, options[selected]);
                    }
                    
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    renderKatexInElement(feedbackEl);
                    container.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        if (parseInt(b.dataset.index) === correctAnswerIndex) b.classList.add('correct');
                        else if (parseInt(b.dataset.index) === selected) b.classList.add('incorrect');
                    });
                    markStepAsCompleted(container);
                });
            },
            createFillInTheBlankQuiz(args, container) {
                const { sentence, correctAnswer, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createFillInTheBlankQuiz';
                container.dataset.quizArgs = JSON.stringify(args);

                container.innerHTML = `<p>${sentence.replace("___", `<input type="text" class="quiz-fib-input" placeholder="...">`)}</p><button class="check-fib-btn">Kiểm tra</button><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.check-fib-btn').addEventListener('click', () => {
                    const input = container.querySelector('input');
                    const userAnswer = input.value.trim();
                    const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    
                    input.disabled = true;
                    container.querySelector('.check-fib-btn').disabled = true;
                    
                    let feedbackHTML = `<p><strong>Giải thích:</strong> ${explanation}</p><div class="feedback-actions"></div>`;
                    feedbackEl.innerHTML = feedbackHTML;
                    const actionsContainer = feedbackEl.querySelector('.feedback-actions');
                    if(isCorrect) {
                         actionsContainer.innerHTML = `<button class="expand-btn">Mở rộng kiến thức ✨</button>`;
                         actionsContainer.querySelector('.expand-btn').onclick = () => requestExpansion(args);
                    } else {
                        actionsContainer.innerHTML = `<button class="reinforce-btn">Củng cố kiến thức 🤔</button>`;
                        actionsContainer.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, userAnswer);
                    }
                    
                    renderKatexInElement(feedbackEl);
                    feedbackEl.className = `quiz-feedback visible ${isCorrect ? 'correct' : 'incorrect'}`;
                    input.classList.add(isCorrect ? 'correct' : 'incorrect');
                    if (!isCorrect) input.value += ` (Đúng: ${correctAnswer})`;
                    markStepAsCompleted(container);
                });
            },
            createTrueFalseQuiz(args, container) {
                const { statement, isCorrect, explanation } = args;
                if (!container) return;
                container.dataset.quizType = 'createTrueFalseQuiz';
                container.dataset.quizArgs = JSON.stringify(args);

                container.innerHTML = `<p>${statement}</p><div class="quiz-tf-options"><button data-answer="true">Đúng</button><button data-answer="false">Sai</button></div><div class="quiz-feedback"></div>`;
                renderKatexInElement(container);
                container.querySelector('.quiz-tf-options').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn || btn.parentElement.querySelector(':disabled')) return;
                    
                    const answer = btn.dataset.answer === 'true';
                    const isCorrectAnswer = answer === isCorrect;
                    const feedbackEl = container.querySelector('.quiz-feedback');
                    
                    let feedbackHTML = `<p>${explanation}</p><div class="feedback-actions"></div>`;
                    feedbackEl.innerHTML = feedbackHTML;
                    const actionsContainer = feedbackEl.querySelector('.feedback-actions');
                     if(isCorrectAnswer) {
                         actionsContainer.innerHTML = `<button class="expand-btn">Mở rộng kiến thức ✨</button>`;
                         actionsContainer.querySelector('.expand-btn').onclick = () => requestExpansion(args);
                    } else {
                        actionsContainer.innerHTML = `<button class="reinforce-btn">Củng cố kiến thức 🤔</button>`;
                        actionsContainer.querySelector('.reinforce-btn').onclick = () => requestReinforcement(args, answer ? 'Đúng' : 'Sai');
                    }
                    
                    renderKatexInElement(feedbackEl);
                    feedbackEl.className = `quiz-feedback visible ${isCorrectAnswer ? 'correct' : 'incorrect'}`;
                    container.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        if ((b.dataset.answer === 'true') === isCorrect) b.classList.add('correct');
                    });
                    if (!isCorrectAnswer) btn.classList.add('incorrect');
                    markStepAsCompleted(container);
                });
            }
        };

        const firebaseConfig = {
            apiKey: "AIzaSyC3fY7kRz2P9BBIBd_jr7b3z5ZUpG5JH8g",
            authDomain: "cboxauto-minh.firebaseapp.com",
            projectId: "cboxauto-minh",
            storageBucket: "cboxauto-minh.appspot.com",
            messagingSenderId: "476350924183",
            appId: "1:476350924183:web:d40a9da3c8902e1d7230d2"
        };
        const app = initializeApp(firebaseConfig);
        const topicInput = document.getElementById('topicInput');
        const generatePathButton = document.getElementById('generatePathButton');
        const clearProgressButton = document.getElementById('clearProgressButton');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');

        function updateStatus(type, message) { statusMessage.className = `status-message ${type}`; statusMessage.innerHTML = message; }
        function toggleButtonLoading(isLoading) { const btnTxt = generatePathButton.querySelector('.button-text'); generatePathButton.disabled = isLoading; generatePathButton.classList.toggle('loading', isLoading); btnTxt.textContent = isLoading ? 'Đang tạo...' : 'Tạo Lộ trình'; }
        
        function parseAiJson(text) {
            const match = text.match(/```(json)?\s*([\s\S]*?)\s*```/); 
            let jsonString = text;
            if (match && match[2]) {
                jsonString = match[2].trim();
            } else {
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace > firstBrace) {
                    jsonString = text.substring(firstBrace, lastBrace + 1);
                }
            }
            try { return JSON.parse(jsonString); } catch (e) {
                console.warn("Lỗi JSON parse lần 1, thử sửa lỗi...", e);
                const repairedString = jsonString.replace(/,\s*([}\]])/g, '$1');
                try { return JSON.parse(repairedString); } catch (finalError) {
                     console.error("Không thể sửa và parse JSON:", finalError);
                     throw new Error("Dữ liệu JSON từ AI không hợp lệ.");
                }
            }
        }
        
        const quizTools = [{ 
            functionDeclarations: [
                { name: 'createMultipleChoiceQuiz', description: 'Tạo một câu hỏi trắc nghiệm.', parameters: { type: 'OBJECT', properties: { question: { type: 'STRING' }, options: { type: 'ARRAY', items: { type: 'STRING' } }, correctAnswerIndex: { type: 'NUMBER' }, explanation: { type: 'STRING', description: 'Giải thích ngắn gọn tại sao đáp án lại đúng.' } }, required: ['question', 'options', 'correctAnswerIndex', 'explanation'] } },
                { name: 'createFillInTheBlankQuiz', description: 'Tạo một câu hỏi điền vào chỗ trống.', parameters: { type: 'OBJECT', properties: { sentence: { type: 'STRING', description: 'Câu chứa ký hiệu ___ cho chỗ trống.' }, correctAnswer: { type: 'STRING' }, explanation: { type: 'STRING', description: 'Giải thích ngắn gọn tại sao đáp án lại đúng.' } }, required: ['sentence', 'correctAnswer', 'explanation'] } },
                { name: 'createTrueFalseQuiz', description: 'Tạo một câu hỏi dạng Đúng hoặc Sai.', parameters: { type: 'OBJECT', properties: { statement: { type: 'STRING' }, isCorrect: { type: 'BOOLEAN' }, explanation: { type: 'STRING', description: 'Giải thích ngắn gọn tại sao đáp án lại đúng.' } }, required: ['statement', 'isCorrect', 'explanation'] } }
            ]
        }];

        let model;
        try {
            model = getGenerativeModel(getAI(app), { model: "gemini-2.5-flash" }); 
            updateStatus('success-text', "Mô hình AI đã sẵn sàng!");
        } catch (e) {
            console.error("Lỗi khởi tạo AI Model:", e);
            updateStatus('error-text', `Lỗi khởi tạo AI Model: ${e.message}.`);
        }
        
        async function getLessonDetail(topic, detailElement) {
            if (!model) { detailElement.innerHTML = `<p class="error">Mô hình AI chưa sẵn sàng.</p>`; return; }
            detailElement.innerHTML = '<div class="small-spinner"></div>';
            
            const prompt = `Bạn là một gia sư AI chuyên nghiệp, chuyên tạo nội dung giáo dục có cấu trúc. Hãy tạo một bài học hoàn chỉnh về chủ đề: "${topic}".
            
            **QUY TẮC BẮT BUỘC VỀ ĐỊNH DẠNG:**
            1.  Đối với TẤT CẢ các chuỗi văn bản, bao gồm nội dung trong khối JSON và các tham số của 'tools' (như 'question', 'explanation'), mọi công thức toán học PHẢI dùng cú pháp KaTeX.
            2.  Các dấu backslash đơn '\\' PHẢI được escape thành '\\\\'. Ví dụ: công thức $C = 2\\pi r$ phải được viết là "C = 2\\\\pi r" trong chuỗi.
            
            **YÊU CẦU PHẢN HỒI:**
            Phản hồi của bạn PHẢI bao gồm 2 phần:
            
            1.  **Nội dung bài học:** Cung cấp phần này trong một khối mã JSON hợp lệ.
            \`\`\`json
            {
              "lessonTitle": "...",
              "introduction": "...",
              "contentBlocks": [
                { "type": "explanation", "title": "...", "content": "..." },
                { "type": "example", "title": "...", "content": "..." }
              ]
            }
            \`\`\`
            
            2.  **Bài tập thực hành:** Ngay sau khối JSON, hãy sử dụng các công cụ (tools) đã được cung cấp để tạo ra 2-3 câu hỏi ôn tập liên quan trực tiếp đến nội dung bài học.`;
            
            try {
                const result = await model.generateContent({
                    contents: [{ role: 'user', parts: [{ text: prompt }] }],
                    tools: quizTools
                });

                const response = result.response;
                const rawText = response.text();
                
                const lessonData = parseAiJson(rawText);
                renderStructuredLesson(lessonData, detailElement);

                const functionCalls = response.functionCalls();
                if (functionCalls && functionCalls.length > 0) {
                    renderSummaryQuiz(functionCalls, detailElement);
                }
                
                saveState();
            } catch (error) {
                console.error("Lỗi khi lấy chi tiết bài học:", error);
                detailElement.innerHTML = `<p class="status-message error-text">Không thể tải nội dung. Vấn đề có thể do dữ liệu từ AI không hợp lệ. Vui lòng thử lại.</p><button class="retry-button">Thử lại</button>`;
                detailElement.querySelector('.retry-button').addEventListener('click', () => getLessonDetail(topic, detailElement));
            }
        }

        function renderStructuredLesson(data, parentElement) {
            parentElement.innerHTML = ''; 
            if (data.introduction) {
                const introBlock = document.createElement('div');
                introBlock.className = 'lesson-block explanation';
                introBlock.innerHTML = `<div class="lesson-block-title">🧠 <span>${data.lessonTitle || 'Giới thiệu'}</span></div><div class="lesson-content">${marked.parse(data.introduction)}</div>`;
                parentElement.appendChild(introBlock);
            }
            if (data.contentBlocks && Array.isArray(data.contentBlocks)) {
                data.contentBlocks.forEach(block => {
                    const blockEl = document.createElement('div');
                    blockEl.className = `lesson-block ${block.type || 'explanation'}`;
                    blockEl.innerHTML = `<div class="lesson-block-title">${getIconForBlockType(block.type)}<span>${block.title}</span></div><div class="lesson-content">${marked.parse(block.content)}</div>`;
                    parentElement.appendChild(blockEl);
                });
            }
            renderKatexInElement(parentElement);
        }
        
        function getIconForBlockType(type) {
            switch(type) { case 'example': return `💡`; case 'note': return `📌`; case 'explanation': default: return `🧠`; }
        }

        function renderSummaryQuiz(functionCalls, parentElement) {
            const block = document.createElement('div');
            block.className = 'practice-set';
            block.innerHTML = `<div class="summary-quiz-title">📝 <span>Bài tập tổng kết</span></div>`;
            parentElement.appendChild(block);

            functionCalls.forEach(call => {
                const exerciseContainer = document.createElement('div');
                exerciseContainer.className = 'quiz-container';
                block.appendChild(exerciseContainer);
                
                const implementation = toolImplementations[call.name];
                if (implementation) {
                    implementation(call.args, exerciseContainer);
                } else {
                    console.warn(`Không tìm thấy hàm triển khai cho công cụ: ${call.name}`);
                    exerciseContainer.textContent = `Lỗi: Không thể hiển thị bài tập loại "${call.name}".`;
                }
            });
        }

        async function generateLearningPath() {
             if (!model) { updateStatus('error-text', "Mô hình AI chưa được khởi tạo."); return; }
             const topic = topicInput.value.trim();
             if (!topic) { updateStatus('error-text', "Vui lòng nhập một chủ đề!"); return; }

             const pathLengthSelect = document.getElementById('pathLengthSelect');
             const pathLength = pathLengthSelect.value;
             
             // NEW: Get selected learner level
             const learnerLevelSelect = document.getElementById('learnerLevelSelect');
             const learnerLevel = learnerLevelSelect.value;

             updateStatus('info-text', `Đang tạo lộ trình...`);
             responseContainer.innerHTML = '<div class="large-spinner"></div>';
             toggleButtonLoading(true);

             // NEW: Update prompt with both length and level
             const prompt = `Tạo một lộ trình học gồm ${pathLength} rõ ràng và tuần tự cho chủ đề: "${topic}", phù hợp với trình độ của một "${learnerLevel}". Chỉ trả lời bằng một đối tượng JSON hợp lệ duy nhất, không có văn bản nào khác. Cấu trúc: {"learningPath": ["Bước 1: Giới thiệu...", "Bước 2: Tìm hiểu sâu...", ...]}`;
             
             try {
                const result = await model.generateContent(prompt);
                const pathData = parseAiJson(result.response.text());
                const pathItems = pathData.learningPath;
                if (!Array.isArray(pathItems) || pathItems.length === 0) throw new Error("Invalid path data");
                responseContainer.innerHTML = `<div class="learning-path"><ol>${pathItems.map((item, index) => `<li data-topic="${item.replace(/"/g, '&quot;')}" data-state="${index === 0 ? 'unlocked' : 'locked'}"><span class="lesson-title">${item}</span><div class="lesson-detail"></div></li>`).join('')}</ol></div>`;
                updateStatus('success-text', "Đã tạo lộ trình! Nhấp vào mục đầu tiên để bắt đầu.");
                saveState();
             } catch (error) {
                console.error("Lỗi khi tạo lộ trình:", error);
                responseContainer.innerHTML = `<p class="status-message error-text">Không thể tạo lộ trình. Vui lòng thử lại.</p>`;
                updateStatus('error-text', `Lỗi: ${error.message}`);
             } finally {
                toggleButtonLoading(false);
             }
        }
        
        async function requestReinforcement(questionArgs, userAnswer) {
            showTutorModal("Củng cố kiến thức", '<div class="small-spinner"></div>');
            const questionText = questionArgs.question || questionArgs.statement;
            const correctAnswer = questionArgs.correctAnswer || (questionArgs.options ? questionArgs.options[questionArgs.correctAnswerIndex] : 'N/A');
            const prompt = `Bạn là một gia sư AI tận tình. Một học sinh vừa trả lời SAI một câu hỏi. Hãy cung cấp một bài học ngắn gọn (bằng tiếng Việt, dùng Markdown) để giúp họ hiểu rõ lỗi sai và củng cố kiến thức.
            - **Câu hỏi:** "${questionText}"
            - **Câu trả lời sai của học sinh:** "${userAnswer}"
            - **Đáp án đúng:** "${correctAnswer}"
            
            Bài học của bạn nên có:
            1.  **Phân tích lỗi sai:** Giải thích tại sao câu trả lời của họ chưa đúng.
            2.  **Giải thích khái niệm:** Giảng lại ngắn gọn về kiến thức cốt lõi.
            3.  **Ví dụ minh họa:** Cung cấp 1-2 ví dụ khác để làm rõ.`;
            try {
                const result = await model.generateContent(prompt);
                showTutorModal("Củng cố kiến thức", marked.parse(result.response.text()));
            } catch(e) { showTutorModal("Lỗi", "Không thể kết nối với AI để tạo bài học."); }
        }

        async function requestExpansion(questionArgs) {
            showTutorModal("Mở rộng kiến thức", '<div class="small-spinner"></div>');
            const questionText = questionArgs.question || questionArgs.statement;
            const prompt = `Bạn là một gia sư AI thân thiện. Một học sinh vừa trả lời ĐÚNG câu hỏi sau: "${questionText}". 
            Hãy khen ngợi họ và cung cấp một mẩu kiến thức mở rộng ngắn gọn (bằng tiếng Việt, dùng Markdown) để giúp họ hiểu sâu hơn về chủ đề liên quan hoặc một ứng dụng thú vị của kiến thức đó.`;
            try {
                const result = await model.generateContent(prompt);
                showTutorModal("Mở rộng kiến thức", marked.parse(result.response.text()));
            } catch(e) { showTutorModal("Lỗi", "Không thể kết nối với AI để tạo bài học."); }
        }


        responseContainer.addEventListener('click', async (event) => {
            const li = event.target.closest('li');
            if (!li) return;
            if (li.dataset.state === 'locked') { li.style.animation = 'shake 0.5s'; setTimeout(() => li.style.animation = '', 500); return; }
            if (event.target.closest('.quiz-container') || event.target.closest('.feedback-actions') || event.target.classList.contains('retry-button')) return;
            
            const wasActive = li.classList.contains('active');
            responseContainer.querySelectorAll('li').forEach(item => item.classList.remove('active'));
            if (!wasActive) {
                li.classList.add('active');
                const detailEl = li.querySelector('.lesson-detail');
                if (detailEl && detailEl.innerHTML === '') {
                    await getLessonDetail(li.dataset.topic, detailEl);
                }
            }
            saveState();
        });

        generatePathButton.addEventListener("click", generateLearningPath);

        async function generateWelcomeBackMessage(mainTopic, lastLessonTopic) {
            if (!model || !lastLessonTopic) return;
            const welcomeContainer = document.getElementById('welcomeMessage');
            welcomeContainer.style.display = 'block';
            welcomeContainer.innerHTML = `<div class="small-spinner"></div> <p>AI đang viết lời chào mừng...</p>`;

            const prompt = `Bạn là một trợ lý học tập AI thân thiện. Người dùng vừa quay lại ứng dụng học tập. Hãy tạo một lời chào mừng ngắn gọn (2-3 câu), thân thiện và khích lệ để chào họ quay trở lại. - Chủ đề chính họ đang học là: "${mainTopic}" - Bài học gần nhất họ xem là: "${lastLessonTopic}". Gợi ý cho họ tiếp tục học từ bài đó. Trả lời bằng văn bản thuần túy, không dùng Markdown hay JSON.`;

            try {
                const result = await model.generateContent(prompt);
                const message = result.response.text().replace(/\n/g, '<br>');
                welcomeContainer.innerHTML = `<p><strong>Trợ lý AI:</strong> ${message}</p>`;
            } catch (error) {
                console.error("Lỗi tạo lời chào:", error);
                welcomeContainer.innerHTML = `<p>Chào mừng bạn đã quay trở lại! Hãy cùng tiếp tục học về <strong>${mainTopic}</strong> nhé.</p>`;
            }
        }
        
        function rehydrateQuizzes() {
            responseContainer.querySelectorAll('.quiz-container').forEach(container => {
                const type = container.dataset.quizType;
                const argsJSON = container.dataset.quizArgs;
                
                const isAnswered = container.querySelector('button:disabled');

                if (type && argsJSON && toolImplementations[type] && !isAnswered) {
                    try {
                        const args = JSON.parse(argsJSON);
                        toolImplementations[type](args, container);
                    } catch (e) {
                        console.error("Lỗi khi rehydrate quiz:", e, container);
                    }
                }
            });
        }

        function loadState() {
            const savedStateJSON = localStorage.getItem(LS_KEY);
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    topicInput.value = savedState.topic;
                    responseContainer.innerHTML = savedState.pathHTML;
                    
                    responseContainer.querySelectorAll('.lesson-content, .quiz-container, .quiz-feedback').forEach(el => {
                        renderKatexInElement(el);
                    });
                    
                    rehydrateQuizzes();
                    
                    const lastActiveLI = responseContainer.querySelector('li.active');
                    generateWelcomeBackMessage(savedState.topic, lastActiveLI?.dataset.topic);
                    updateStatus('success-text', 'Đã tải lại lộ trình học của bạn!');
                } catch(e) {
                    console.error("Lỗi khi tải tiến trình:", e);
                    localStorage.removeItem(LS_KEY); 
                }
            }
        }
        
        clearProgressButton.addEventListener('click', () => {
             const userConfirmed = window.confirm('Bạn có chắc muốn xóa tất cả tiến trình đã lưu?');
            if (userConfirmed) {
                localStorage.removeItem(LS_KEY);
                topicInput.value = '';
                responseContainer.innerHTML = 'Chưa có lộ trình nào được tạo...';
                document.getElementById('welcomeMessage').style.display = 'none';
                updateStatus('info-text', 'Đã xóa tiến trình. Bạn có thể bắt đầu lại.');
            }
        });

        document.addEventListener('DOMContentLoaded', loadState);

    </script>
</body>
</html>

